<html><head>
<!-- otrs.github.io -->
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../../../../../documentation.css">
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="../../../../../documentation.js"></script>
<link rel="icon" type="image/png" sizes="32x32" href="../../../../../../images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../../../../../images/favicon-16x16.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script>
$(document).ready(function() {

    // Hint languages to prevent false matches (php for example).
    hljs.configure({
        languages: ['perl', 'javascript', 'xml', 'html', 'css', 'json', 'yaml']
    });

    // programlistings in manuals
    $('pre.programlisting').each(function(i, block) {
        hljs.highlightBlock(block);
    });
    // code snippets in Perl API docs
    $('.pod pre').addClass('perl').each(function(i, block) {
        hljs.highlightBlock(block);
    });
});</script>
<!-- otrs.github.io -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Package Porting</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="OTRS 6 - Developer Manual"><link rel="up" href="how-to-publish-extensions.html" title="Chapter 4. How to Publish Your OTRS Extensions"><link rel="prev" href="package-building.html" title="Package Building"><link rel="next" href="contributing.html" title="Chapter 5. Contributing to OTRS"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Package Porting</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="package-building.html">Prev</a> </td><th width="60%" align="center">Chapter 4. How to Publish Your OTRS Extensions</th><td width="20%" align="right"> <a accesskey="n" href="contributing.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a name="package-porting"></a>Package Porting</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6">From OTRS 5 to 6</a></span></dt><dd><dl><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-datetime">Date and time calculation</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-user-multiupload">Adding the drag &amp; drop multiupload</a></span></dt><dt><span class="section"><a href="package-porting.html#packge-porting-5-to-6-admin-modules">Improvements to administration screens</a></span></dt><dd><dl><dt><span class="section"><a href="package-porting.html#packge-porting-5-to-6-breadcrumbs">Add breadcrumbs to administration screens</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-saveandcontinue">Add <span class="emphasis"><em>Save</em></span> and <span class="emphasis"><em>Save and finish</em></span> buttons to administration screens</a></span></dt></dl></dd><dt><span class="section"><a href="package-porting.html#packge-porting-5-to-6-configuration-files">Migrate configuration files</a></span></dt><dd><dl><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-XML-config-file-format">XML configuration file format</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-perl-config-file-format">Perl configuration file format</a></span></dt></dl></dd><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-perldoc-structure">Perldoc structure changed</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-javascript-templating-improvements">Improvements to templating and working with JavaScript</a></span></dt><dd><dl><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-javascript-refactor">JavaScript removed from templates</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-richtext-template">Template files for rich text editor removed</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-javascript-translations">Translations in JavaScript files</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-javascript-handover">Handover data from Perl to JavaScript</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-javascript-templates">HTML templates for JavaScript</a></span></dt></dl></dd><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-user-permissions">Checking user permissions</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-ticket-api">Ticket API changes</a></span></dt><dd><dl><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-ticket-api-ticketget"><code class="literal">TicketGet()</code></a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-ticket-api-linkobject-events"><code class="literal">LinkObject</code> Events</a></span></dt></dl></dd><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-article-api">Article API changes</a></span></dt><dd><dl><dt><span class="section"><a href="package-porting.html#otrs6-article-methods">Meta Article API</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-article-backend-api">Article Backend API</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-article-search-index">Article Search Index</a></span></dt></dl></dd><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-sysconfig-changes">SysConfig API changes</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-linkobject-changes"><code class="literal">LinkObject</code> API changes</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-postmaster-filter-communication-log">Communication Log support for additional PostMaster Filters</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-process-mailqueue-for-ut">Process MailQueue for unit tests</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-5-to-6-agentticketzoom-widget-handling">Widget Handling in Ticket Zoom Screen</a></span></dt></dl></dd><dt><span class="section"><a href="package-porting.html#package-porting-4-to-5">From OTRS 4 to 5</a></span></dt><dd><dl><dt><span class="section"><a href="package-porting.html#id-1.5.4.4.3"><code class="filename">Kernel/Output/HTML</code> restructured</a></span></dt><dt><span class="section"><a href="package-porting.html#id-1.5.4.4.4">Pre-Output-Filters</a></span></dt><dt><span class="section"><a href="package-porting.html#id-1.5.4.4.5">IE 8 and IE 9</a></span></dt><dt><span class="section"><a href="package-porting.html#id-1.5.4.4.6">GenericInterface API change in "Ticket" connector</a></span></dt><dt><span class="section"><a href="package-porting.html#id-1.5.4.4.7">Preview functions in dynamic statistics</a></span></dt><dt><span class="section"><a href="package-porting.html#id-1.5.4.4.8">HTML print discarded</a></span></dt><dt><span class="section"><a href="package-porting.html#id-1.5.4.4.9">Translation string extraction improved</a></span></dt></dl></dd><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4">From OTRS 3.3 to 4</a></span></dt><dd><dl><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4-objectmanager">New Object Handling</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4-cache"><code class="literal">CacheInternalObject</code> removed</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4-scheduler-location">Scheduler backend files moved</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4-sopm-code-tags">Update code sections in SOPM files</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4-template-engine">New Template Engine</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4-fontawesome">New FontAwesome version</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4-unit-tests">Unit Tests</a></span></dt><dt><span class="section"><a href="package-porting.html#package-porting-33-to-4-custom-ticket-history-types">Custom Ticket History types</a></span></dt></dl></dd></dl></div><p>
        With every new minor or major version of OTRS, you need to port your package(s) and make sure they still work
        with the OTRS API.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="package-porting-5-to-6"></a>From OTRS 5 to 6</h3></div></div></div><p>
        This section lists changes that you need to examine when porting your package from OTRS 5 to 6.
    </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-datetime"></a>Date and time calculation</h4></div></div></div><p>
            In OTRS 6, a new module for date and time calculation was added:
            <code class="literal">Kernel::System::DateTime</code>. The module <code class="literal">Kernel::System::Time</code> is now
            deprecated and should not be used for new code anymore.
        </p><p>
            The main advantage of the new <code class="literal">Kernel::System::DateTime</code> module is the support for real
            time zones like <code class="literal">Europe/Berlin</code> instead of time offsets in hours like
            <code class="literal">+2</code>. Note that also the old <code class="literal">Kernel::System::Time</code> module has been
            improved to support time zones. Time offsets have been completely dropped. This means that any code that
            uses time offsets for calculations has to be ported to use the new <code class="literal">DateTime</code> module
            instead. Code that doesn't fiddle around with time offsets itself can be left untouched in most cases. You
            just have to make sure that upon creation of a <code class="literal">Kernel::System::Time</code> object a valid time
            zone will be given.
        </p><p>
            Here's an example for porting time offset code to time zones:
        </p><p>
            </p><pre class="programlisting">
my $TimeObject     = $Kernel::OM-&gt;Get('Kernel::System::Time'); # Assume a time offset of 0 for this time object
my $SystemTime     = $TimeObject-&gt;TimeStamp2SystemTime( String =&gt; '2004-08-14 22:45:00' );
my $UserTimeZone   = '+2'; # normally retrieved via config or param
my $UserSystemTime = $SystemTime + $UserTimeZone * 3600;
my $UserTimeStamp  = $TimeObject-&gt;SystemTime2TimeStamp( SystemTime =&gt; $UserSystemTime );
            </pre><p>
        </p><p>
            Code using the new <code class="literal">Kernel::System::DateTime</code> module:
        </p><p>
            </p><pre class="programlisting">
my $DateTimeObject = $Kernel::OM-&gt;Create('Kernel::System::DateTime'); # This implicitly sets the configured OTRS time zone
my $UserTimeZone   = 'Europe/Berlin'; # normally retrieved via config or param
$DateTimeObject-&gt;ToTimeZone( TimeZone =&gt; $UserTimeZone );
my $SystemTime    = $DateTimeObject-&gt;ToEpoch(); # note that the epoch is independent from the time zone, it's always calculated for UTC
my $UserTimeStamp = $DateTimeObject-&gt;ToString();
            </pre><p>
        </p><p>
            Please note that the returned time values with the new <code class="code">Get()</code> function in the <code class="literal">Kernel::System::DateTime</code> module
            are without leading zero instead of the old <code class="code">SystemTime2Date()</code> function in the <code class="literal">Kernel::System::Time</code> module.
            In the new <code class="literal">Kernel::System::DateTime</code> module the function <code class="code">Format()</code> returns the date/time as string formatted
            according to the given format.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-user-multiupload"></a>Adding the drag &amp; drop multiupload</h4></div></div></div><p>
            For OTRS 6, a multi attachment upload functionality was added. To implement the multi attachment upload in other extensions it is necessary to remove the attachment part from the template file, also the <code class="code">JSOnDocumentComplete</code> parts (<code class="literal">AttachmentDelete</code> and <code class="literal">AttachmentUpload</code>). Please keep in mind, in some cases the JavaScript parts are already outsourced in <code class="filename">Core.Agent.XXX</code> files.
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
                Please note that this is currently only applicable for places where it actually makes sense to have the possibility to upload multiple files (like <code class="literal">AgentTicketPhone</code>, <code class="literal">AgentTicketCompose</code>, etc.). This is not usable out of the box for admin screens.
            </p></div><p>
            To include the new multi attachment upload in the template, replace the existing <code class="code">input type="file"</code> with the following code in your <code class="filename">.tt</code> template file:
        </p><p>
            </p><pre class="programlisting">
&lt;label&gt;[% Translate("Attachments") | html %]:&lt;/label&gt;
&lt;div class="Field"&gt;
[% INCLUDE "FormElements/AttachmentList.tt" %]
&lt;/div&gt;
&lt;div class="Clear"&gt;&lt;/div&gt;
            </pre><p>
        </p><p>
            It is also necessary to remove the <code class="code">IsUpload</code> variable and all other <code class="code">IsUpload</code> parts from the Perl module. Code parts like following are not needed anymore:
        </p><p>
            </p><pre class="programlisting">
my $IsUpload = ( $ParamObject-&gt;GetParam( Param =&gt; 'AttachmentUpload' ) ? 1 : 0 );
            </pre><p>
        </p><p>
            Additional to that, the Attachment Layout Block needs to be replaced:
        </p><p>
            </p><pre class="programlisting">
$LayoutObject-&gt;Block(
    Name =&gt; 'Attachment',
    Data =&gt; $Attachment,
);
            </pre><p>
        </p><p>
            Replace it with this code:
        </p><p>
            </p><pre class="programlisting">
push @{ $Param{AttachmentList} }, $Attachment;
            </pre><p>
        </p><p>
            If the module where you want to integrate multi upload supports standard templates, make sure to add a section to have a human readable file size format right after the attachments of the selected template have been loaded (see e.g. <code class="literal">AgentTicketPhone</code> for reference):
        </p><p>
            </p><pre class="programlisting">
for my $Attachment (@TicketAttachments) {
    $Attachment-&gt;{Filesize} = $LayoutObject-&gt;HumanReadableDataSize(
        Size =&gt; $Attachment-&gt;{Filesize},
    );
}
            </pre><p>
        </p><p>
            When adding selenium unit tests for the modules you ported, please take a look at <code class="filename">Selenium/Agent/MultiAttachmentUpload.t</code> for reference.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="packge-porting-5-to-6-admin-modules"></a>Improvements to administration screens</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="packge-porting-5-to-6-breadcrumbs"></a>Add breadcrumbs to administration screens</h5></div></div></div><p>
                In OTRS 6, all admin modules should have a breadcrumb. The breadcrumb only needs to be added on the <code class="filename">.tt</code> template file and should be placed right after the h1 headline on top of the file. Additionally, the headline should receive the class <code class="code">InvisibleText</code> to make it only <span class="emphasis"><em>visible</em></span> for screen readers.
            </p><pre class="programlisting">
&lt;div class="MainBox ARIARoleMain LayoutFixedSidebar SidebarFirst"&gt;
    &lt;h1 class="InvisibleText"&gt;[% Translate("Name of your module") | html %]&lt;/h1&gt;
[% BreadcrumbPath = [
        {
            Name =&gt; Translate('Name of your module'),
        },
    ]
%]
[% INCLUDE "Breadcrumb.tt" Path = BreadcrumbPath %]
...
            </pre><p>
                Please make sure to add the correct breadcrumb for all levels of your admin module (e.g. <code class="literal">Subaction</code>s):
            </p><pre class="programlisting">
[% BreadcrumbPath = [
        {
            Name =&gt; Translate('Module Home Screen'),
            Link =&gt; Env("Action"),
        },
        {
            Name =&gt; Translate("Some Subaction"),
        },
    ]
%]

[% INCLUDE "Breadcrumb.tt" Path = BreadcrumbPath %]
                </pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-saveandcontinue"></a>Add <span class="emphasis"><em>Save</em></span> and <span class="emphasis"><em>Save and finish</em></span> buttons to administration screens</h5></div></div></div><p>
                Admin modules in OTRS 6 should not only have a <span class="emphasis"><em>Save</em></span> button, but also a <span class="emphasis"><em>Save and finish</em></span> button. <span class="emphasis"><em>Save</em></span> should leave the user on the same edit page after saving, <span class="emphasis"><em>Save and finish</em></span> should lead back to the overview of the entity the user is currently working on. Please see existing OTRS admin screens for reference.
            </p><p>
                </p><pre class="programlisting">
&lt;div class="Field SpacingTop SaveButtons"&gt;
    &lt;button class="Primary CallForAction" id="SubmitAndContinue" type="submit" value="[% Translate("Save") | html %]"&gt;&lt;span&gt;[% Translate("Save") | html %]&lt;/span&gt;&lt;/button&gt;
    [% Translate("or") | html %]
    &lt;button class="Primary CallForAction" id="Submit" type="submit" value="[% Translate("Save") | html %]"&gt;&lt;span&gt;[% Translate("Save and finish") | html %]&lt;/span&gt;&lt;/button&gt;
    [% Translate("or") | html %]
    &lt;a href="[% Env("Baselink") %]Action=[% Env("Action") %]"&gt;&lt;span&gt;[% Translate("Cancel") | html %]&lt;/span&gt;&lt;/a&gt;
&lt;/div&gt;
                </pre><p>
            </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="packge-porting-5-to-6-configuration-files"></a>Migrate configuration files</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-XML-config-file-format"></a>XML configuration file format</h5></div></div></div><p>
                OTRS 6 uses a new <a class="link" href="how-it-works.html#xml-config" title="XML Configuration Files">XML configuration file format</a>
                and the location of configuration files moved
                from <code class="filename">Kernel/Config/Files</code> to <code class="filename">Kernel/Config/Files/XML</code>.
                To convert existing XML configuration files to the new format and location, you can use the following
                tool that is part of the OTRS framework:
            </p><p>
                </p><pre class="programlisting">
bin/otrs.Console.pl Dev::Tools::Migrate::ConfigXMLStructure --source-directory Kernel/Config/Files
Migrating configuration XML files...
Kernel/Config/Files/Calendar.xml -&gt; Kernel/Config/Files/XML/Calendar.xml... Done.
Kernel/Config/Files/CloudServices.xml -&gt; Kernel/Config/Files/XML/CloudServices.xml... Done.
Kernel/Config/Files/Daemon.xml -&gt; Kernel/Config/Files/XML/Daemon.xml... Done.
Kernel/Config/Files/Framework.xml -&gt; Kernel/Config/Files/XML/Framework.xml... Done.
Kernel/Config/Files/GenericInterface.xml -&gt; Kernel/Config/Files/XML/GenericInterface.xml... Done.
Kernel/Config/Files/ProcessManagement.xml -&gt; Kernel/Config/Files/XML/ProcessManagement.xml... Done.
Kernel/Config/Files/Ticket.xml -&gt; Kernel/Config/Files/XML/Ticket.xml... Done.

Done.
                </pre><p>
            </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-perl-config-file-format"></a>Perl configuration file format</h5></div></div></div><p>
                OTRS 6 speeds up configuration file loading by dropping support for the old configuration format (1)
                that just used sequential Perl code and had to be run by <code class="literal">eval</code>
                and instead enforcing the new package-based format (1.1) for Perl configuration files.
                OTRS 6+ can only load files with this format, please make sure to convert any custom developments to it
                (see <code class="filename">Kernel/Config/Files/ZZZ*.pm</code> for examples). Every Perl configuration file
                needs to contain a package with a <code class="literal">Load()</code> method.
            </p><p>
                In the past, Perl configuration files were sometimes misused as an autoload mechanism
                to override code in existing packages. This is not necessary any more as OTRS 6 features a dedicated
                <code class="literal">Autoload</code> mechanism. Please see <code class="filename">Kernel/Autoload/Test.pm</code> for a demonstration
                on how to use this mechanism to add a method in an existing file.
            </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-perldoc-structure"></a>Perldoc structure changed</h4></div></div></div><p>
            The structure of POD in Perl files was slightly improved and should be adapted in all files. POD is now also
            enforced to be syntactically correct.
        </p><p>
            What was previously called <code class="literal">SYNOPSIS</code> is now changed to <code class="literal">DESCRIPTION</code>, as
            a synopsis typically provides a few popular code usage examples and not a description of the module itself.
            An additional synopsis can be provided, of course. Here's how an example:
        </p><p>
            </p><pre class="programlisting">
=head1 NAME

Kernel::System::ObjectManager - Central singleton manager and object instance generator

=head1 SYNOPSIS

# In toplevel scripts only!
local $Kernel::OM = Kernel::System::ObjectManager-&gt;new();

# Everywhere: get a singleton instance (and create it, if needed).
my $ConfigObject = $Kernel::OM-&gt;Get('Kernel::Config');

# Remove singleton objects and all their dependencies.
$Kernel::OM-&gt;ObjectsDiscard(
    Objects            =&gt; ['Kernel::System::Ticket', 'Kernel::System::Queue'],
);

=head1 DESCRIPTION

The ObjectManager is the central place to create and access singleton OTRS objects (via C&lt;L&lt;/Get()&gt;&gt;)
as well as create regular (unmanaged) object instances (via C&lt;L&lt;/Create()&gt;&gt;).

            </pre><p>
        </p><p>
            In case the <code class="literal">DESCRIPTION</code> does not add any value to the line in the <code class="literal">NAME</code>
            section, it should be rewritten or removed altogether.
        </p><p>
            The second important change is that functions are now documented as <code class="literal">=head2</code> instead of the
            previously used <code class="literal">=item</code>.
        </p><p>
            </p><pre class="programlisting">
=head2 Get()

Retrieves a singleton object, and if it not yet exists, implicitly creates one for you.

my $ConfigObject = $Kernel::OM-&gt;Get('Kernel::Config');

# On the second call, this returns the same ConfigObject as above.
my $ConfigObject2 = $Kernel::OM-&gt;Get('Kernel::Config');

=cut

sub Get { ... }
            </pre><p>
        </p><p>
            These changes lead to an improved online API documentation as can be seen in the ObjectManager documentation
            for
            <a class="ulink" href="http://otrs.github.io/doc/api/otrs/5.0/Perl/Kernel/System/ObjectManager.pm.html" target="_top">OTRS 5</a>
            and
            <a class="ulink" href="http://otrs.github.io/doc/api/otrs/6.0/Perl/Kernel/System/ObjectManager.pm.html" target="_top">OTRS 6</a>.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-javascript-templating-improvements"></a>Improvements to templating and working with JavaScript</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-javascript-refactor"></a>JavaScript removed from templates</h5></div></div></div><p>
                With OTRS 6, all JavaScript - especially located in <code class="literal">JSOnDocumentComplete</code> blocks - is
                removed from template files and moved to JavaScript files instead. Only in very rare conditions JavaScript
                needs to be placed within template files. For all other occurrences, place the JS code in module-specific
                JavaScript files. An <code class="literal">Init()</code> method within such a JavaScript file is executed
                automatically on file load (for the initialization of event bindings etc.) if you register the JavaScript
                file at the OTRS application. This is done by executing <code class="literal">Core.Init.RegisterNamespace(TargetNS,
                'APP_MODULE');</code> at the end of the namespace declaration within the JavaScript file.
            </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-richtext-template"></a>Template files for rich text editor removed</h5></div></div></div><p>
                Along with the refactoring of the JavaScript within template files (see above), the template files for the
                rich text editor (<code class="literal">RichTextEditor.tt</code> and <code class="literal">CustomerRichTextEditor.tt</code>)
                were removed as they are no longer necessary.
            </p><p>
                Typically, these template files were included in the module-specific template files within a block:
            </p><p>
                </p><pre class="programlisting">
[% RenderBlockStart("RichText") %]
[% InsertTemplate("RichTextEditor.tt") %]
[% RenderBlockEnd("RichText") %]
                </pre><p>
            </p><p>
                This is no longer needed and can be removed. Instead of calling this block from the Perl module, it is now
                necessary to set the needed rich text parameters there. Instead of:
            </p><p>
                </p><pre class="programlisting">
$LayoutObject-&gt;Block(
    Name =&gt; 'RichText',
    Data =&gt; \%Param,
);
                </pre><p>
            </p><p>
                you now have to call:
            </p><p>
                </p><pre class="programlisting">
$LayoutObject-&gt;SetRichTextParameters(
    Data =&gt; \%Param,
);
                </pre><p>
            </p><p>Same rule applies for customer interface. Remove RichText blocks from <code class="filename">CustomerRichTextEditor.tt</code> and
            apply following code instead:</p><p>
                </p><pre class="programlisting">
$LayoutObject-&gt;CustomerSetRichTextParameters(
    Data =&gt; \%Param,
);
                </pre><p>
            </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-javascript-translations"></a>Translations in JavaScript files</h5></div></div></div><p>
                Adding translatable strings in JavaScript was quite difficult in OTRS. The string had to be translated in
                Perl or in the template and then sent to the JavaScript function. With OTRS 6, translation of strings is
                possible directly in the JavaScript file. All other workarounds, especially blocks in the templates only for
                translating strings, should be removed.
            </p><p>
                Instead, the new JavaScript translation namespace <code class="literal">Core.Language</code> should be used to
                translate strings directly in the JS file:
            </p><p>
                </p><pre class="programlisting">
Core.Language.Translate('The string to translate');
                </pre><p>
            </p><p>
                It is also possible to handover JS variables to be replaced in the string directly:
            </p><p>
                </p><pre class="programlisting">
Core.Language.Translate('The %s to %s', 'string', 'translate');
                </pre><p>
            </p><p>
                Every <code class="literal">%s</code> is replaced by the variable given as extra parameter. The number of parameters
                is not limited.
            </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-javascript-handover"></a>Handover data from Perl to JavaScript</h5></div></div></div><p>
                To achieve template files without JavaScript code, some other workarounds had to be replaced with an
                appropriate solution. Besides translations, also the handover of data from Perl to JavaScript has been a
                problem in OTRS. The workaround was to add a JavaScript block in the template in which JavaScript variables
                were declared and filled with template tags based on data handed over from Perl to the template.
            </p><p>
                The handover process of data from Perl to JavaScript is now much easier in OTRS 6. To send specific data as
                variable from Perl to JavaScript, one only has to call a function on Perl-side. The data is than
                automatically available in JavaScript.
            </p><p>
                In Perl you only have to call:
            </p><p>
                </p><pre class="programlisting">
$Self-&gt;{LayoutObject}-&gt;AddJSData(
    Key   =&gt; 'KeyToBeAvailableInJS',
    Value =&gt; $YourData,
);
                </pre><p>
            </p><p>
                The <code class="literal">Value</code> parameter is automatically converted to a JSON object and can also contain
                complex data.
            </p><p>
                In JavaScript you can get the data with:
            </p><p>
                </p><pre class="programlisting">
Core.Config.Get('KeyToBeAvailableInJS');
            </pre><p>
            </p><p>
                This replaces all workarounds which need to be removed when porting a module to OTRS 6, because JavaScript
                in template files is now only allowed in very rare conditions (see above).
            </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-javascript-templates"></a>HTML templates for JavaScript</h5></div></div></div><p>
                OTRS 6 exposes new JavaScript template API via <code class="literal">Core.Template</code> class. You can use it in
                your JavaScript code in a similar way as you use <code class="literal">TemplateToolkit</code> from Perl code.
            </p><p>
                Here's an example for porting existing <code class="literal">jQuery</code> based code to new template API:
            </p><p>
                </p><pre class="programlisting">
var DivID = 'MyDiv',
    DivText = 'Hello, world!';

$('&lt;div /&gt;').addClass('CSSClass')
    .attr('id', DivID)
    .text(DivText)
    .appendTo('body');
                </pre><p>
            </p><p>
                First, make sure to create a new template file under
                <code class="literal">Kernel/Output/JavaScript/Templates/Standard</code> folder. In doing this, you should keep
                following in mind:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
                            Create a subfolder with name of your <code class="literal">Module</code>.
                        </p></li><li class="listitem"><p>
                            You may reuse any existing subfolder structure but only if it makes sense for your component
                            (e.g. <code class="literal">Agent/MyModule/</code> or <code class="literal">Agent/Admin/MyModule/</code>).
                        </p></li><li class="listitem"><p>
                            Use <code class="literal">.html.tmpl</code> as extension for template file.
                        </p></li><li class="listitem"><p>
                            Name templates succinctly and clearly in order to avoid confusion (i.e. good:
                            <code class="literal">Agent/MyModule/SettingsDialog.html.tmpl</code>, bad:
                            <code class="literal">Agent/SettingsDialogTemplate.html.tmpl</code>).
                        </p></li></ul></div><p>
            </p><p>
                Then, add your HTML to the template file, making sure to use placeholders for any variables you might need:
            </p><p>
                </p><pre class="programlisting">
&lt;div id="{{ DivID }}" class="CSSClass"&gt;
    {{ DivText | Translate }}
&lt;/div&gt;
                </pre><p>
            </p><p>
                Then, just get rendered HTML by calling <code class="literal">Core.Template.Render</code> method with template path
                (without extension) and object containing variables for replacement:
            </p><p>
                </p><pre class="programlisting">
var DivHTML = Core.Template.Render('Agent/MyModule/SettingsDialog', {
    DivID: 'MyDiv',
    DivText: 'Hello, world!'
});

$(DivHTML).appendTo('body');
                </pre><p>
            </p><p>
                Internally, <code class="literal">Core.Template</code> uses Nunjucks engine for parsing templates. Essentially, any
                valid Nunjucks syntax is supported, please see
                <a class="ulink" href="https://mozilla.github.io/nunjucks/templating.html" target="_top">their documentation</a> for more
                information.
            </p><p>
                Here are some tips:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
                            You can use <code class="literal">| Translate</code> filter for string translation to current language.
                        </p></li><li class="listitem"><p>
                            All <code class="literal">{{ VarName }}</code> variable outputs are HTML escaped by default. If you need
                            to output some existing HTML, please use <code class="literal">| safe</code> filter to bypass escaping.
                        </p></li><li class="listitem"><p>
                            Use <code class="literal">| urlencode</code> for encoding URL parameters.
                        </p></li><li class="listitem"><p>
                            Complex structures in replacement object are supported, so feel free to pass arrays or hashes
                            and iterate over them right from template. For example, look at <code class="literal">{% for %}</code>
                            syntax in <a class="ulink" href="https://mozilla.github.io/nunjucks/templating.html#for" target="_top"> Nunjucks
                            documentation</a>.
                        </p></li></ul></div><p>
            </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-user-permissions"></a>Checking user permissions</h4></div></div></div><p>
            Before OTRS 6, user permissions were stored in the session and passed to the <code class="code">LayoutObject</code> as
            attributes, which were then in turn accessed to determine user permissions like <code class="code">if
            ($LayoutObject-&gt;{'UserIsGroup[admin]'}) { ... }</code>.
        </p><p>
            With OTRS 6, permissions are no longer stored in the session and also not passed to the
            <code class="code">LayoutObject</code>. Please switch your code to calling <code class="code">PermissionCheck()</code> on
            <code class="code">Kernel::System::Group</code> (for agents) or <code class="code">Kernel::System::CustomerGroup</code> (for
            customers). Here's an example:
        </p><p>
            </p><pre class="programlisting">
my $HasPermission = $Kernel::OM-&gt;Get('Kernel::System::Group')-&gt;PermissionCheck(
UserID    =&gt; $UserID,
GroupName =&gt; $GroupName,
Type      =&gt; 'move_into',
);
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-ticket-api"></a>Ticket API changes</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-ticket-api-ticketget"></a><code class="literal">TicketGet()</code></h5></div></div></div><p>
                For OTRS 6, all extensions need to be checked and ported from <code class="literal">$Ticket{SolutionTime}</code> to
                <code class="literal">$Ticket{Closed}</code> if <code class="literal">TicketGet()</code> is called with the
                <code class="literal">Extended</code> parameter (see
                bug<a class="ulink" href="http://bugs.otrs.org/show_bug.cgi?id=11872" target="_top">#11872</a>).
            </p><p>
                Additionally, the database column <code class="literal">ticket.create_time_unix</code> was removed, and likewise the
                value <code class="literal">CreateTimeUnix</code> from the <code class="literal">TicketGet()</code> result data.
                Please use the value <code class="literal">Created</code> (database column <code class="literal">ticket.create_time</code>) instead.
            </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-ticket-api-linkobject-events"></a><code class="literal">LinkObject</code> Events</h5></div></div></div><p>
                In OTRS 6, old ticket-specific <code class="literal">LinkObject</code> events have been dropped:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">TicketSlaveLinkAdd</code></p></li><li class="listitem"><p><code class="literal">TicketSlaveLinkDelete</code></p></li><li class="listitem"><p><code class="literal">TicketMasterLinkDelete</code></p></li></ul></div><p>
            </p><p>
                Any event handlers listening on these events should be ported to two new events instead:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">LinkObjectLinkAdd</code></p></li><li class="listitem"><p><code class="literal">LinkObjectLinkDelete</code></p></li></ul></div><p>
            </p><p>
                These new events will be triggered any time a link is added or deleted by <code class="literal">LinkObject</code>,
                regardless of the object type. <code class="literal">Data</code> parameter will contain all information your event
                handlers might need for further processing, e.g.:
            </p><p>
                </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">SourceObject</code></span></dt><dd><p>
                                Name of the link source object (e.g. <code class="literal">Ticket</code>).
                            </p></dd><dt><span class="term"><code class="literal">SourceKey</code></span></dt><dd><p>
                                Key of the link source object (e.g. <code class="literal">TicketID</code>).
                            </p></dd><dt><span class="term"><code class="literal">TargetObject</code></span></dt><dd><p>
                                Name of the link target object (e.g. <code class="literal">FAQItem</code>).
                            </p></dd><dt><span class="term"><code class="literal">TargetKey</code></span></dt><dd><p>
                                Key of the link target object (e.g. <code class="literal">FAQItemID</code>).
                            </p></dd><dt><span class="term"><code class="literal">Type</code></span></dt><dd><p>
                                Type of the link (e.g. <code class="literal">ParentChild</code>).
                            </p></dd><dt><span class="term"><code class="literal">State</code></span></dt><dd><p>
                                State of the link (<code class="literal">Valid</code> or <code class="literal">Temporary</code>).
                            </p></dd></dl></div><p>
            </p><p>
                With these new events in place, any events specific for custom <code class="literal">LinkObject</code> module
                implementations can be dropped, and all event handlers ported to use them instead. Since source and
                target object names are provided in the event itself, it would be trivial to make them run only in
                specific situations.
            </p><p>
                To register your event handler for these new events, make sure to add a registration in the
                configuration, for example:
            </p><p>
                </p><pre class="programlisting">
&lt;!-- OLD STYLE --&gt;
&lt;ConfigItem Name="LinkObject::EventModulePost###1000-SampleModule" Required="0" Valid="1"&gt;
    &lt;Description Translatable="1"&gt;Event handler for sample link object module.&lt;/Description&gt;
    &lt;Group&gt;Framework&lt;/Group&gt;
    &lt;SubGroup&gt;Core::Event::Package&lt;/SubGroup&gt;
    &lt;Setting&gt;
        &lt;Hash&gt;
            &lt;Item Key="Module"&gt;Kernel::System::LinkObject::Event::SampleModule&lt;/Item&gt;
            &lt;Item Key="Event"&gt;(LinkObjectLinkAdd|LinkObjectLinkDelete)&lt;/Item&gt;
            &lt;Item Key="Transaction"&gt;1&lt;/Item&gt;
        &lt;/Hash&gt;
    &lt;/Setting&gt;
&lt;/ConfigItem&gt;

&lt;!-- NEW STYLE --&gt;
&lt;Setting Name="LinkObject::EventModulePost###1000-SampleModule" Required="0" Valid="1"&gt;
    &lt;Description Translatable="1"&gt;Event handler for sample link object module.&lt;/Description&gt;
    &lt;Navigation&gt;Core::Event::Package&lt;/Navigation&gt;
    &lt;Value&gt;
        &lt;Hash&gt;
            &lt;Item Key="Module"&gt;Kernel::System::LinkObject::Event::SampleModule&lt;/Item&gt;
            &lt;Item Key="Event"&gt;(LinkObjectLinkAdd|LinkObjectLinkDelete)&lt;/Item&gt;
            &lt;Item Key="Transaction"&gt;1&lt;/Item&gt;
        &lt;/Hash&gt;
    &lt;/Value&gt;
&lt;/Setting&gt;
                </pre><p>
            </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-article-api"></a>Article API changes</h4></div></div></div><p>
            In OTRS 6, changes to Article API have been made, in preparations for new <span class="emphasis"><em>Omni Channel</em></span>
            infrastructure.
        </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="otrs6-article-methods"></a>Meta Article API</h5></div></div></div><p>
                Article object now provides top-level article functions that do not involve back-end related data.
            </p><p>
                Following methods related to articles have been moved to
                <code class="literal">Kernel::System::Ticket::Article</code> object:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">ArticleFlagSet()</code></p></li><li class="listitem"><p><code class="literal">ArticleFlagDelete()</code></p></li><li class="listitem"><p><code class="literal">ArticleFlagGet()</code></p></li><li class="listitem"><p><code class="literal">ArticleFlagsOfTicketGet()</code></p></li><li class="listitem"><p><code class="literal">ArticleAccountedTimeGet()</code></p></li><li class="listitem"><p><code class="literal">ArticleAccountedTimeDelete()</code></p></li><li class="listitem"><p><code class="literal">ArticleSenderTypeList()</code></p></li><li class="listitem"><p><code class="literal">ArticleSenderTypeLookup()</code></p></li><li class="listitem"><p><code class="literal">SearchStringStopWordsFind()</code></p></li><li class="listitem"><p><code class="literal">SearchStringStopWordsUsageWarningActive()</code></p></li></ul></div><p>
            </p><p>
                If you are referencing any of these methods via <code class="literal">Kernel::System::Ticket</code> object in your
                code, please switch to Article object and use it instead. For example:
            </p><p>
                </p><pre class="programlisting">
    my $ArticleObject = $Kernel::OM-&gt;Get('Kernel::System::Ticket::Article');

    my %ArticleSenderTypeList = $ArticleObject-&gt;ArticleSenderTypeList();
                </pre><p>
            </p><p>
                New <code class="literal">ArticleList()</code> method is now provided by the article object, and can be used for
                article listing and locating. This method implements filters and article numbering and returns article
                meta data only as an ordered list. For example:
            </p><p>
                </p><pre class="programlisting">
my @Articles = $ArticleObject-&gt;ArticleList(
    TicketID             =&gt; 123,
    CommunicationChannel =&gt; 'Email',            # optional, to limit to a certain CommunicationChannel
    SenderType           =&gt; 'customer',         # optional, to limit to a certain article SenderType
    IsVisibleForCustomer =&gt; 1,                  # optional, to limit to a certain visibility
    OnlyFirst            =&gt; 1,                  # optional, only return first match, or
    OnlyLast             =&gt; 1,                  # optional, only return last match
);
                </pre><p>
            </p><p>
                Following methods related to articles have been dropped all-together. If you are using any of them in
                your code, please evaluate possibility of alternatives.
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
                              <code class="literal">ArticleFirstArticle()</code> (use
                              <code class="literal">ArticleList( OnlyFirst =&gt; 1)</code> instead)
                          </p></li><li class="listitem"><p>
                              <code class="literal">ArticleLastCustomerArticle()</code> (use
                              <code class="literal">ArticleList( SenderType =&gt; 'customer', OnlyLast =&gt; 1)</code> or similar)
                          </p></li><li class="listitem"><p><code class="literal">ArticleCount()</code> (use <code class="literal">ArticleList()</code> instead)</p></li><li class="listitem"><p>
                              <code class="literal">ArticlePage()</code> (reimplemented in <code class="literal">AgentTicketZoom</code>)
                          </p></li><li class="listitem"><p><code class="literal">ArticleTypeList()</code></p></li><li class="listitem"><p><code class="literal">ArticleTypeLookup()</code></p></li><li class="listitem"><p><code class="literal">ArticleIndex()</code> (use <code class="literal">ArticleList()</code> instead)</p></li><li class="listitem"><p><code class="literal">ArticleContentIndex()</code></p></li></ul></div><p>
            </p><p>
                To work with article data please use new article backend API. To get correct backend object for an
                article, please use:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">BackendForArticle(%Article)</code></p></li><li class="listitem"><p><code class="literal">BackendForChannel( ChannelName =&gt; $ChannelName )</code></p></li></ul></div><p>
            </p><p>
                <code class="literal">BackendForArticle()</code> returns the correct back end for a given article, or the invalid
                back end, so that you can always expect a back end object instance that can be used for chain-calling.
            </p><p>
                </p><pre class="programlisting">
my $ArticleBackendObject = $ArticleObject-&gt;BackendForArticle( TicketID =&gt; 42, ArticleID =&gt; 123 );
                </pre><p>
            </p><p>
                <code class="literal">BackendForChannel()</code> returns the correct back end for a given communication channel.
            </p><p>
                </p><pre class="programlisting">
my $ArticleBackendObject = $ArticleObject-&gt;BackendForChannel( ChannelName =&gt; 'Email' );
                </pre><p>
            </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-article-backend-api"></a>Article Backend API</h5></div></div></div><p>
                All other article data and related methods have been moved to separate backends. Every communication
                channel now has a dedicated backend API that handles article data and can be used to manipulate it.
            </p><p>
                OTRS 6 Free ships with some default channels and corresponding backends:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Email (equivalent to old <code class="literal">email</code> article types)</p></li><li class="listitem"><p>Phone (equivalent to old <code class="literal">phone</code> article types)</p></li><li class="listitem"><p>Internal (equivalent to old <code class="literal">note</code> article types)</p></li><li class="listitem"><p>Chat (equivalent to old <code class="literal">chat</code> article types)</p></li></ul></div><p>
            </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
                    While chat article backend is available in OTRS 6 Free, it is only utilized when system has a valid
                    <span class="bold"><strong>OTRS Business Solution™</strong></span> installed.
                </p></div><p>
                Article data manipulation can be managed via following backend methods:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">ArticleCreate()</code></p></li><li class="listitem"><p><code class="literal">ArticleUpdate()</code></p></li><li class="listitem"><p><code class="literal">ArticleGet()</code></p></li><li class="listitem"><p><code class="literal">ArticleDelete()</code></p></li></ul></div><p>
            </p><p>
                All of these methods have dropped article type parameter, which must be substituted for
                <code class="literal">SenderType</code> and <code class="literal">IsVisibleForCustomer</code> parameter combination. In
                addition, all these methods now also require <code class="literal">TicketID</code> and <code class="literal">UserID</code>
                parameters.
            </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
                    Since changes in article API are system-wide, any code using the old API must be ported for OTRS 6.
                    This includes any web service definitions which leverage these methods directly via GenericInterface
                    for example. They will need to be re-assessed and adapted to provide all required parameters to the
                    new API during requests and manage subsequent responses in new format.
                </p></div><p>
                Please note that returning hash of <code class="literal">ArticleGet()</code> has changed, and some things (like
                ticket data) might be missing. Utilize parameters like <code class="literal">DynamicFields =&gt; 1</code> and
                <code class="literal">RealNames =&gt; 1</code> to get more information.
            </p><p>
                In addition, attachment data is not returned any more, please use combination of following methods from
                the article backends:
            </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">ArticleAttachmentIndex()</code></p></li><li class="listitem"><p><code class="literal">ArticleAttachment()</code></p></li></ul></div><p>
            </p><p>
                Note that <code class="literal">ArticleAttachmentIndex()</code> parameters and behavior has changed. Instead of
                old strip parameter use combination of new <code class="literal">ExcludePlainText</code>,
                <code class="literal">ExcludeHTMLBody</code> and <code class="literal">ExcludeInline</code>.
            </p><p>
                As an example, here is how to get all article and attachment data in the same hash:
            </p><p>
                </p><pre class="programlisting">
my @Articles = $ArticleObject-&gt;ArticleList(
    TicketID =&gt; $TicketID,
);

ARTICLE:
for my $Article (@Articles) {

    # Make sure to retrieve backend object for this specific article.
    my $ArticleBackendObject = $ArticleObject-&gt;BackendForArticle( %{$Article} );

    my %ArticleData = $ArticleBackendObject-&gt;ArticleGet(
        %{$Article},
        DynamicFields =&gt; 1,
        UserID        =&gt; $UserID,
    );
    $Article = \%ArticleData;

    # Get attachment index (without attachments).
    my %AtmIndex = $ArticleBackendObject-&gt;ArticleAttachmentIndex(
        ArticleID =&gt; $Article-&gt;{ArticleID},
        UserID    =&gt; $UserID,
    );
    next ARTICLE if !%AtmIndex;

    my @Attachments;
    ATTACHMENT:
    for my $FileID ( sort keys %AtmIndex ) {
        my %Attachment = $ArticleBackendObject-&gt;ArticleAttachment(
            ArticleID =&gt; $Article-&gt;{ArticleID},
            FileID    =&gt; $FileID,
            UserID    =&gt; $UserID,
        );
        next ATTACHMENT if !%Attachment;

        $Attachment{FileID} = $FileID;
        $Attachment{Content} = encode_base64( $Attachment{Content} );

        push @Attachments, \%Attachment;
    }

    # Include attachment data in article hash.
    $Article-&gt;{Atms} = \@Attachments;
}
                </pre><p>
            </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="package-porting-5-to-6-article-search-index"></a>Article Search Index</h5></div></div></div><p>
                To make article indexing more generic, article backends now provide information necessary for properly
                indexing article data. Index will be created similar to old <code class="literal">StaticDB</code> mechanism and
                stored in a dedicated article search table.
            </p><p>
                Since now every article backend can provide search on arbitrary number of article fields, use
                <code class="literal">BackendSearchableFieldsGet()</code> method to get information about them. This data can
                also be used for forming requests to <code class="literal">TicketSearch()</code> method. Coincidentally, some
                <code class="literal">TicketSearch()</code> parameters have changed their name to also include article backend
                information, for example:
            </p><p>
                </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col><col></colgroup><thead><tr><th>Old parameter</th><th>New parameter</th></tr></thead><tbody><tr><td><code class="literal">From</code></td><td><code class="literal">MIMEBase_From</code></td></tr><tr><td><code class="literal">To</code></td><td><code class="literal">MIMEBase_To</code></td></tr><tr><td><code class="literal">Cc</code></td><td><code class="literal">MIMEBase_Cc</code></td></tr><tr><td><code class="literal">Subject</code></td><td><code class="literal">MIMEBase_Subject</code></td></tr><tr><td><code class="literal">Body</code></td><td><code class="literal">MIMEBase_Body</code></td></tr><tr><td><code class="literal">AttachmentName</code></td><td><code class="literal">MIMEBase_AttachmentName</code></td></tr></tbody></table></div><p>
            </p><p>
                Additionally, article search indexing will be done in an async call now, in order to off-load index
                calculation to a separate task. While this is fine for production systems, it might create new problems
                in certain situations, e.g. unit tests. If you are manually creating articles in your unit test, but
                expect it to be searchable immediately after created, make sure to manually call the new
                <code class="literal">ArticleSearchIndexBuild()</code> method on article object.
            </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-sysconfig-changes"></a>SysConfig API changes</h4></div></div></div><p>
            Note that in OTRS 6 SysConfig API was changed, so you should check if the methods are still existing.
            For example, <code class="literal">ConfigItemUpdate()</code> is removed. To replace it you should use combination
            of the following methods:
        </p><p>
            </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">SettingLock()</code></p></li><li class="listitem"><p><code class="literal">SettingUpdate()</code></p></li><li class="listitem"><p><code class="literal">ConfigurationDeploy()</code></p></li></ul></div><p>
        </p><p>
            In case that you want to update a configuration setting during a <code class="literal">CodeInstall</code> section of a package, you could use
            <code class="literal">SettingsSet()</code>.  It does all previously mentioned steps and it can be used for multiple settings at once.
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Do not use <code class="literal">SettingSet()</code> in the SysConfig GUI itself.</p></div><p>
            </p><pre class="programlisting">
my $Success = $SysConfigObject-&gt;SettingsSet(
    UserID   =&gt; 1,                                      # (required) UserID
    Comments =&gt; 'Deployment comment',                   # (optional) Comment
    Settings =&gt; [                                       # (required) List of settings to update.
        {
            Name                   =&gt; 'Setting::Name',  # (required)
            EffectiveValue         =&gt; 'Value',          # (optional)
            IsValid                =&gt; 1,                # (optional)
            UserModificationActive =&gt; 1,                # (optional)
        },
        ...
    ],
);
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-linkobject-changes"></a><code class="literal">LinkObject</code> API changes</h4></div></div></div><p>
            Note that <code class="literal">LinkObject</code> was slightly modified in the OTRS 6 and methods
            <code class="literal">LinkList()</code> and <code class="literal">LinkKeyList()</code> might return different
            result if <code class="literal">Direction</code> parameter is used. Consider changing <code class="literal">Direction</code>.
        </p><p>
            Old code:
        </p><p>
            </p><pre class="programlisting">
my $LinkList = $LinkObject-&gt;LinkList(
    Object    =&gt; 'Ticket',
    Key       =&gt; '321',
    Object2   =&gt; 'FAQ',
    State     =&gt; 'Valid',
    Type      =&gt; 'ParentChild',
    Direction =&gt; 'Target',
    UserID    =&gt; 1,
);
            </pre><p>
        </p><p>
            New code:
        </p><p>
            </p><pre class="programlisting">
my $LinkList = $LinkObject-&gt;LinkList(
    Object    =&gt; 'Ticket',
    Key       =&gt; '321',
    Object2   =&gt; 'FAQ',
    State     =&gt; 'Valid',
    Type      =&gt; 'ParentChild',
    Direction =&gt; 'Source',
    UserID    =&gt; 1,
);
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-postmaster-filter-communication-log"></a>Communication Log support for additional PostMaster Filters</h4></div></div></div><p>
            As part of email handling improvements for OTRS 6, a new logging mechanism was added to OTRS 6, exclusively
            used for incoming and outgoing communications. All PostMaster filters were enriched with this new
            <a class="link" href="ch02s03.html#log-mechanism-communication-log" title="Communication Log">Communication Log</a> API, which means any additional
            filters coming with packages should also leverage the new log feature.
        </p><p>
            If your package implements additional PostMaster filters, make sure to get acquainted with
            <a class="link" href="ch02s03.html#log-mechanism-communication-log" title="Communication Log">API usage instructions</a>. Also, you can get an example
            of how to implement this logging mechanism by looking the code in the
            <code class="literal">Kernel::System::PostMaster::NewTicket</code>.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-process-mailqueue-for-ut"></a>Process MailQueue for unit tests</h4></div></div></div><p>
            As part of email handling improvements for OTRS 6, all emails are now sent asynchronously, that means they are saved in a queue for future processing.
        </p><p>
            To the unit tests that depend on emails continue to work properly is necessary to force the processing of the email queue.
        </p><p>
            Make sure to start with a clean queue:
        </p><p>
            </p><pre class="programlisting">
                my $MailQueueObject = $Kernel::OM-&gt;Get('Kernel::System::MailQueue');
                $MailQueueObject-&gt;Delete();
            </pre><p>
        </p><p>
            If for some reason you can't clean completely the queue, e.g. selenium unit tests,
            just delete the items created during the tests:
        </p><p>
            </p><pre class="programlisting">
                my $MailQueueObject = $Kernel::OM-&gt;Get('Kernel::System::MailQueue');
                my %MailQueueCurrentItems = map { $_-&gt;{ID} =&gt; $_ } @{ $MailQueueObject-&gt;List() || [] };

                my $Items = $MailQueueObject-&gt;List();
                MAIL_QUEUE_ITEM:
                for my $Item ( @{$Items} ) {
                    next MAIL_QUEUE_ITEM if $MailQueueCurrentItems{ $Item-&gt;{ID} };
                    $MailQueueObject-&gt;Delete(
                        ID =&gt; $Item-&gt;{ID},
                    );
                }
            </pre><p>
        </p><p>
            Process the queue after the code that you expect to send emails:
        </p><p>
            </p><pre class="programlisting">
                my $MailQueueObject = $Kernel::OM-&gt;Get('Kernel::System::MailQueue');
                my $QueueItems      = $MailQueueObject-&gt;List();
                for my $Item ( @{$QueueItems} ) {
                    $MailQueueObject-&gt;Send( %{$Item} );
                }
            </pre><p>
        </p><p>
            Or process only the ones created during the tests:
        </p><p>
            </p><pre class="programlisting">
                my $MailQueueObject = $Kernel::OM-&gt;Get('Kernel::System::MailQueue');
                my $QueueItems      = $MailQueueObject-&gt;List();
                MAIL_QUEUE_ITEM:
                for my $Item ( @{$QueueItems} ) {
                    next MAIL_QUEUE_ITEM if $MailQueueCurrentItems{ $Item-&gt;{ID} };
                    $MailQueueObject-&gt;Send( %{$Item} );
                }
            </pre><p>
        </p><p>
            Depending on your case, you may need to clean the queue after or before
            processing it.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-5-to-6-agentticketzoom-widget-handling"></a>Widget Handling in Ticket Zoom Screen</h4></div></div></div><p>
            The widgets in the ticket zoom screen have been improved to work in a more generic way. With OTRS 6, it is
            now possible to add new widgets for the ticket zoom screen via the SysConfig. It is possible to
            configure the used module, the location of the widget (e.g. Sidebar) and if the content should be loaded synchronously (default) or via AJAX.
        </p><p>
            Here is an example configuration for the default widgets:
        </p><p>
            </p><pre class="programlisting">
&lt;Setting Name="Ticket::Frontend::AgentTicketZoom###Widgets###0100-TicketInformation" Required="0" Valid="1"&gt;
    &lt;Description Translatable="1"&gt;AgentTicketZoom widget that displays ticket data in the side bar.&lt;/Description&gt;
    &lt;Navigation&gt;Frontend::Agent::View::TicketZoom&lt;/Navigation&gt;
    &lt;Value&gt;
        &lt;Hash&gt;
            &lt;Item Key="Module"&gt;Kernel::Output::HTML::TicketZoom::TicketInformation&lt;/Item&gt;
            &lt;Item Key="Location"&gt;Sidebar&lt;/Item&gt;
        &lt;/Hash&gt;
    &lt;/Value&gt;
&lt;/Setting&gt;
&lt;Setting Name="Ticket::Frontend::AgentTicketZoom###Widgets###0200-CustomerInformation" Required="0" Valid="1"&gt;
    &lt;Description Translatable="1"&gt;AgentTicketZoom widget that displays customer information for the ticket in the side bar.&lt;/Description&gt;
    &lt;Navigation&gt;Frontend::Agent::View::TicketZoom&lt;/Navigation&gt;
    &lt;Value&gt;
        &lt;Hash&gt;
            &lt;Item Key="Module"&gt;Kernel::Output::HTML::TicketZoom::CustomerInformation&lt;/Item&gt;
            &lt;Item Key="Location"&gt;Sidebar&lt;/Item&gt;
            &lt;Item Key="Async"&gt;1&lt;/Item&gt;
        &lt;/Hash&gt;
    &lt;/Value&gt;
&lt;/Setting&gt;
            </pre><p>
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
                With this change, the template blocks in the widget code have been removed, so you should check if you use
                the old widget blocks in some output filters via
                <code class="literal">Frontend::Template::GenerateBlockHooks</code> functionality, and implement it in the new
                fashion.
            </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="package-porting-4-to-5"></a>From OTRS 4 to 5</h3></div></div></div><p>
        This section lists changes that you need to examine when porting your package from OTRS 4 to 5.
    </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.5.4.4.3"></a><code class="filename">Kernel/Output/HTML</code> restructured</h4></div></div></div><p>
            In OTRS 5, <code class="filename">Kernel/Output/HTML</code> was restructured. All Perl modules (except
            <code class="filename">Layout.pm</code>) were moved to subdirectories (one for every module layer). Template (theme)
            files were also moved from <code class="filename">Kernel/Output/HTML/Standard</code> to
            <code class="filename">Kernel/Output/HTML/Templates/Standard</code>. Please perform this migration also in your code.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.5.4.4.4"></a>Pre-Output-Filters</h4></div></div></div><p>
            With OTRS 5 there is no support for <code class="literal">pre</code> output filters any more. These filters changed
            the template content before it was parsed, and that could potentially lead to bad performance issues because
            the templates could not be cached any more and had to be parsed and compiled every time.
        </p><p>
            Just switch from <code class="literal">pre</code> to <code class="literal">post</code> output filters. To translate content, you
            can run <code class="code">$LayoutObject-&gt;Translate()</code> directly. If you need other template features, just define a
            small template file for your output filter and use it to render your content before injecting it into the
            main data. It can also be helpful to use jQuery DOM operations to reorder/replace content on the screen in
            some cases instead of using regular expressions. In this case you would inject the new code somewhere in the
            page as invisible content (e. g. with the class <code class="literal">Hidden</code>), and then move it with jQuery to
            the correct location in the DOM and show it.
        </p><p>
            To make using post output filters easier, there is also a new mechanism to request HTML comment hooks for
            certain templates/blocks. You can add in your module config XML like:
        </p><p>
            </p><pre class="programlisting">
&lt;ConfigItem
Name="Frontend::Template::GenerateBlockHooks###100-OTRSBusiness-ContactWithData"
Required="1" Valid="1"&gt;
    &lt;Description Translatable="1"&gt;Generate HTML comment hooks for
the specified blocks so that filters can use them.&lt;/Description&gt;
    &lt;Group&gt;OTRSBusiness&lt;/Group&gt;
    &lt;SubGroup&gt;Core&lt;/SubGroup&gt;
    &lt;Setting&gt;
        &lt;Hash&gt;
            &lt;Item Key="AgentTicketZoom"&gt;
                &lt;Array&gt;
                    &lt;Item&gt;CustomerTable&lt;/Item&gt;
                &lt;/Array&gt;
            &lt;/Item&gt;
        &lt;/Hash&gt;
    &lt;/Setting&gt;
&lt;/ConfigItem&gt;
            </pre><p>
        </p><p>
            This will cause the block <code class="literal">CustomerTable</code> in <code class="filename">AgentTicketZoom.tt</code> to be
            wrapped in HTML comments each time it is rendered:
        </p><p>
            </p><pre class="programlisting">
&lt;!--HookStartCustomerTable--&gt;
... block output ...
&lt;!--HookEndCustomerTable--&gt;
            </pre><p>
        </p><p>
            With this mechanism every package can request just the block hooks it needs, and they are consistently
            rendered. These HTML comments can then be used in your output filter for easy regular expression matching.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.5.4.4.5"></a>IE 8 and IE 9</h4></div></div></div><p>
            Support for IE 8 and 9
            <a class="ulink" href="https://github.com/OTRS/otrs/commit/3b1aff21984d7b32f626df95e072337245615b36" target="_top">was
            dropped</a>. You can remove any workarounds in your code for these platforms, as well as any old
            <code class="literal">&lt;CSS_IE7&gt;</code> or <code class="literal">&lt;CSS_IE8&gt;</code> loader tags that might still lurk
            in your XML config files.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.5.4.4.6"></a>GenericInterface API change in "Ticket" connector</h4></div></div></div><p>
            The operation <code class="code">TicketGet()</code> returns dynamic field data from ticket and articles differently than
            in OTRS 4. Now they are cleanly  separated from the rest of the static ticket and article fields - they are
            now grouped in a list called <code class="literal">DynamicField</code>. Please adapt any applications using this
            operation accordingly.
        </p><p>
            </p><pre class="programlisting">
# changed from:

Ticket =&gt; [
{
    TicketNumber       =&gt; '20101027000001',
    Title              =&gt; 'some title',
    ...
    DynamicField_X     =&gt; 'value_x',
},
]

# to:

Ticket =&gt; [
{
    TicketNumber       =&gt; '20101027000001',
    Title              =&gt; 'some title',
    ...
    DynamicField =&gt; [
        {
            Name  =&gt; 'some name',
            Value =&gt; 'some value',
        },
    ],
},
]
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.5.4.4.7"></a>Preview functions in dynamic statistics</h4></div></div></div><p>
            The new statistics GUI provides a preview for the current configuration. This must be implemented in the
            statistic modules and usually returns fake / random data for speed reasons. So for any dynamic (matrix)
            statistic that provides the method <code class="code">GetStatElement()</code> you should also add a method
            <code class="code">GetStatElementPreview()</code>, and for every dynamic (table) statistic that provides
            <code class="code">GetStatTable()</code> you should accordingly add <code class="code">GetStatTablePreview()</code>. Otherwise the
            preview in the new statistics GUI will not work for your statistics. You can find example implementations in
            the default OTRS statistics.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.5.4.4.8"></a>HTML print discarded</h4></div></div></div><p>
            Until OTRS 5, the Perl module <code class="literal">PDF::API2</code> was not present on all systems. Therefore a
            fallback HTML print mode existed. With OTRS 5, the module is now bundled and HTML print was dropped.
            <code class="code">$LayoutObject-&gt;PrintHeader()</code> and <code class="code">PrintFooter()</code> are not available any more. Please
            remove the HTML print fallback from your code and change it to generate PDF if necessary.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.5.4.4.9"></a>Translation string extraction improved</h4></div></div></div><p>
            Until OTRS 5, translatable strings could not be extracted from Perl code and Database XML definitions. This
            is now possible and makes dummy templates like <code class="filename">AAA*.tt</code> obsolete. Please see <a class="link" href="localization-translation-mechanism.html" title="Localization / Translation Mechanism">this section</a> for details.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="package-porting-33-to-4"></a>From OTRS 3.3 to 4</h3></div></div></div><p>
        This section lists changes that you need to examine when porting your package from OTRS 3.3 to 4.
    </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-33-to-4-objectmanager"></a>New Object Handling</h4></div></div></div><p>
            Up to OTRS 4, objects used to be created both centrally and also locally and then handed down to all objects
            by passing them to the constructors. With OTRS 4 and later versions, there is now an
            <code class="literal">ObjectManager</code> that centralizes singleton object creation and access.
        </p><p>
            This will require you first of all to change all top level Perl scripts (.pl files only!) to load and
            provide the <code class="literal">ObjectManager</code> to all OTRS objects. Let's look at
            <code class="filename">otrs.CheckDB.pl</code> from OTRS 3.3 as an example:
        </p><p>
            </p><pre class="programlisting">
use strict;
use warnings;

use File::Basename;
use FindBin qw($RealBin);
use lib dirname($RealBin);
use lib dirname($RealBin) . '/Kernel/cpan-lib';
use lib dirname($RealBin) . '/Custom';

use Kernel::Config;
use Kernel::System::Encode;
use Kernel::System::Log;
use Kernel::System::Main;
use Kernel::System::DB;

# create common objects
my %CommonObject = ();
$CommonObject{ConfigObject} = Kernel::Config-&gt;new();
$CommonObject{EncodeObject} = Kernel::System::Encode-&gt;new(%CommonObject);
$CommonObject{LogObject}    = Kernel::System::Log-&gt;new(
    LogPrefix    =&gt; 'OTRS-otrs.CheckDB.pl',
    ConfigObject =&gt; $CommonObject{ConfigObject},
);
$CommonObject{MainObject} = Kernel::System::Main-&gt;new(%CommonObject);
$CommonObject{DBObject}   = Kernel::System::DB-&gt;new(%CommonObject);
            </pre><p>
        </p><p>
            We can see that a lot of code is used to load the packages and create the common objects that must be passed
            to OTRS objects to be used in the script. With OTRS 4, this looks quite different:
        </p><p>
            </p><pre class="programlisting">
use strict;
use warnings;

use File::Basename;
use FindBin qw($RealBin);
use lib dirname($RealBin);
use lib dirname($RealBin) . '/Kernel/cpan-lib';
use lib dirname($RealBin) . '/Custom';

use Kernel::System::ObjectManager;

# create common objects
local $Kernel::OM = Kernel::System::ObjectManager-&gt;new(
'Kernel::System::Log' =&gt; {
    LogPrefix =&gt; 'OTRS-otrs.CheckDB.pl',
},
);

# get database object
my $DBObject = $Kernel::OM-&gt;Get('Kernel::System::DB');
            </pre><p>
        </p><p>
            The new code is a bit shorter than the old. It is no longer necessary to load all the packages, just the
            <code class="literal">ObjectManager</code>. Subsequently <code class="literal">$Kernel::OM-&gt;Get('My::Perl::Package')</code> can
            be used to get instances of objects which only have to be created once. The <code class="literal">LogPrefix</code>
            setting controls the log messages that <code class="literal">Kernel::System::Log</code> writes, it could also be
            omitted.
        </p><p>
            From this example you can also deduce the general porting guide when it comes to accessing objects: don't
            store them in <code class="literal">$Self</code> any more (unless needed for specific reasons). Just fetch and use the
            objects on demand like <code class="code">$Kernel::OM-&gt;Get('Kernel::System::Log')-&gt;Log(...)</code>. This also has the
            benefit that the <code class="literal">Log</code> object will only be created if something must be logged. Sometimes
            it could also be useful to create local variables if an object is used many times in a function, like
            <code class="literal">$DBObject</code> in the example above.
        </p><p>
            There's not much more to know when porting packages that should be loadable by the
            <code class="literal">ObjectManager</code>. They should declare the modules they use (via
            <code class="code">$Kernel::OM-&gt;Get()</code>) like this:
        </p><p>
            </p><pre class="programlisting">
our @ObjectDependencies = (
'Kernel::Config',
'Kernel::System::Log',
'Kernel::System::Main',
);
            </pre><p>
        </p><p>
            The <code class="literal">@ObjectDependencies</code> declaration is needed for the <code class="literal">ObjectManager</code> to
            keep the correct order when destroying the objects.
        </p><p>
            Let's look at <code class="filename">Valid.pm</code> from OTRS 3.3 and 4 to see the difference. Old:
        </p><p>
            </p><pre class="programlisting">
package Kernel::System::Valid;

use strict;
use warnings;

use Kernel::System::CacheInternal;

...

sub new {
my ( $Type, %Param ) = @_;

# allocate new hash for object
my $Self = {};
bless( $Self, $Type );

# check needed objects
for my $Object (qw(DBObject ConfigObject LogObject EncodeObject MainObject)) {
    $Self-&gt;{$Object} = $Param{$Object} || die "Got no $Object!";
}

$Self-&gt;{CacheInternalObject} = Kernel::System::CacheInternal-&gt;new(
    %{$Self},
    Type =&gt; 'Valid',
    TTL  =&gt; 60 * 60 * 24 * 20,
);

return $Self;
}

...

sub ValidList {
my ( $Self, %Param ) = @_;

# read cache
my $CacheKey = 'ValidList';
my $Cache = $Self-&gt;{CacheInternalObject}-&gt;Get( Key =&gt; $CacheKey );
return %{$Cache} if $Cache;

# get list from database
return if !$Self-&gt;{DBObject}-&gt;Prepare( SQL =&gt; 'SELECT id, name FROM valid' );

# fetch the result
my %Data;
while ( my @Row = $Self-&gt;{DBObject}-&gt;FetchrowArray() ) {
    $Data{ $Row[0] } = $Row[1];
}

# set cache
$Self-&gt;{CacheInternalObject}-&gt;Set( Key =&gt; $CacheKey, Value =&gt; \%Data );

return %Data;
}
            </pre><p>
        </p><p>
            New:
        </p><p>
            </p><pre class="programlisting">
package Kernel::System::Valid;

use strict;
use warnings;

our @ObjectDependencies = (
'Kernel::System::Cache',
'Kernel::System::DB',
'Kernel::System::Log',
);

...

sub new {
my ( $Type, %Param ) = @_;

# allocate new hash for object
my $Self = {};
bless( $Self, $Type );

$Self-&gt;{CacheType} = 'Valid';
$Self-&gt;{CacheTTL}  = 60 * 60 * 24 * 20;

return $Self;
}

...

sub ValidList {
my ( $Self, %Param ) = @_;

# read cache
my $CacheKey = 'ValidList';
my $Cache    = $Kernel::OM-&gt;Get('Kernel::System::Cache')-&gt;Get(
    Type =&gt; $Self-&gt;{CacheType},
    Key  =&gt; $CacheKey,
);
return %{$Cache} if $Cache;

# get database object
my $DBObject = $Kernel::OM-&gt;Get('Kernel::System::DB');

# get list from database
return if !$DBObject-&gt;Prepare( SQL =&gt; 'SELECT id, name FROM valid' );

# fetch the result
my %Data;
while ( my @Row = $DBObject-&gt;FetchrowArray() ) {
    $Data{ $Row[0] } = $Row[1];
}

# set cache
$Kernel::OM-&gt;Get('Kernel::System::Cache')-&gt;Set(
    Type  =&gt; $Self-&gt;{CacheType},
    TTL   =&gt; $Self-&gt;{CacheTTL},
    Key   =&gt; $CacheKey,
    Value =&gt; \%Data
);

return %Data;
}
            </pre><p>
        </p><p>
            You can see that the dependencies are declared and the objects are only fetched on demand. We'll talk about
            the <code class="literal">CacheInternalObject</code> in the next section.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-33-to-4-cache"></a><code class="literal">CacheInternalObject</code> removed</h4></div></div></div><p>
            Since <code class="literal">Kernel::System::Cache</code> is now also able to cache in-memory,
            <code class="literal">Kernel::System::CacheInternal</code> was dropped. Please see the previous example for how to
            migrate your code: you need to use the global <code class="literal">Cache</code> object and pass the
            <code class="literal">Type</code> settings with every call to <code class="code">Get()</code>, <code class="code">Set()</code>,
            <code class="code">Delete()</code> and <code class="code">CleanUp()</code>. The <code class="literal">TTL</code> parameter is now optional and
            defaults to 20 days, so you only have to specify it in <code class="code">Get()</code> if you require a different
            <code class="literal">TTL</code> value.
        </p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
                It is especially important to add the <code class="literal">Type</code> to <code class="code">CleanUp()</code> as otherwise not
                just the current cache type but the entire cache would be deleted.
            </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-33-to-4-scheduler-location"></a>Scheduler backend files moved</h4></div></div></div><p>
            The backend files of the scheduler moved from <code class="filename">Kernel/Scheduler</code> to
            <code class="filename">Kernel/System/Scheduler</code>. If you have any custom Task Handler modules, you need to move
            them also.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-33-to-4-sopm-code-tags"></a>Update <a class="link" href="package-building.html#package-code-install" title="&lt;CodeInstall&gt;">code sections</a> in SOPM files</h4></div></div></div><p>
            Code tags in SOPM files have to be updated. Please do not use <code class="literal">$Self</code> any more. In the past
            this was used to get access to OTRS objects like the <code class="literal">MainObject</code>. Please use the
            <code class="literal">ObjectManager</code> now. Here is an example for the old style:
        </p><p>
            </p><pre class="programlisting">
&lt;CodeInstall Type="post"&gt;

# define function name
my $FunctionName = 'CodeInstall';

# create the package name
my $CodeModule = 'var::packagesetup::' . $Param{Structure}-&gt;{Name}-&gt;{Content};

# load the module
if ( $Self-&gt;{MainObject}-&gt;Require($CodeModule) ) {

# create new instance
my $CodeObject = $CodeModule-&gt;new( %{$Self} );

if ($CodeObject) {

    # start method
    if ( !$CodeObject-&gt;$FunctionName(%{$Self}) ) {
        $Self-&gt;{LogObject}-&gt;Log(
            Priority =&gt; 'error',
            Message  =&gt; "Could not call method $FunctionName() on $CodeModule.pm."
        );
    }
}

# error handling
else {
    $Self-&gt;{LogObject}-&gt;Log(
        Priority =&gt; 'error',
        Message  =&gt; "Could not call method new() on $CodeModule.pm."
    );
}
}

&lt;/CodeInstall&gt;
            </pre><p>
        </p><p>
            Now this should be replaced by:
        </p><p>
            </p><pre class="programlisting">
&lt;CodeInstall Type="post"&gt;&lt;![CDATA[
$Kernel::OM-&gt;Get('var::packagesetup::MyPackage')-&gt;CodeInstall();
]]&gt;&lt;/CodeInstall&gt;
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-33-to-4-template-engine"></a>New Template Engine</h4></div></div></div><p>
            With OTRS 4, the DTL template engine was replaced by Template::Toolkit. Please refer to the <a class="link" href="TemplatingMechanism.html" title="Templating Mechanism">Templating section</a> for details on how the new template syntax looks
            like.
        </p><p>
            These are the changes that you need to apply when converting existing DTL templates to the new
            Template::Toolkit syntax:
        </p><div class="table"><a name="id-1.5.4.5.7.4"></a><p class="title"><b>Table 4.1. Template Changes from OTRS 3.3 to 4</b></p><div class="table-contents"><table><thead><tr>
                     <td>DTL Tag</td>
                     <td>Template::Toolkit tag</td>
                 </tr></thead><tbody><tr>
                    <td><code class="literal">$Data{"Name"}</code></td>
                    <td><code class="literal">[% Data.Name %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Data{"Complex-Name"}</code></td>
                    <td><code class="literal">[% Data.item("Complex-Name") %]</code></td>
                </tr><tr>
                    <td><code class="literal">$QData{"Name"}</code></td>
                    <td><code class="literal">[% Data.Name | html %]</code></td>
                </tr><tr>
                    <td><code class="literal">$QData{"Name", "$Length"}</code></td>
                    <td><code class="literal">[% Data.Name | truncate($Length) | html %]</code></td>
                </tr><tr>
                    <td><code class="literal">$LQData{"Name"}</code></td>
                    <td><code class="literal">[% Data.Name | uri %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Quote{"Text", "$Length"}</code></td>
                    <td>cannot be replaced directly, see examples below</td></tr><tr>
                    <td><code class="literal">$Quote{"$Config{"Name"}"}</code></td>
                    <td><code class="literal">[% Config("Name") | html %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Quote{"$Data{"Name"}", "$Length"}</code></td>
                    <td><code class="literal">[% Data.Name | truncate($Length) | html  %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Quote{"$Data{"Content"}","$QData{"MaxLength"}"}</code></td>
                    <td><code class="literal">[% Data.Name | truncate(Data.MaxLength) | html  %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Quote{"$Text{"$Data{"Content"}"}","$QData{"MaxLength"}"}</code></td>
                    <td><code class="literal">[% Data.Content  | Translate | truncate(Data.MaxLength) | html  %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Config{"Name"}</code></td>
                    <td><code class="literal">[% Config("Name") %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Env{"Name"}</code></td>
                    <td><code class="literal">[% Env("Name") %]</code></td>
                </tr><tr>
                    <td><code class="literal">$QEnv{"Name"}</code></td>
                    <td><code class="literal">[% Env("Name") | html %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Text{"Text with %s placeholders", "String"}</code></td>
                    <td><code class="literal">[% Translate("Text with %s placeholders", "String") | html %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Text{"Text with dynamic %s placeholders", "$QData{Name}"}</code></td>
                    <td><code class="literal">[% Translate("Text with dynamic %s placeholders", Data.Name) | html %]</code></td>
                </tr><tr>
                    <td><code class="literal">'$JSText{"Text with dynamic %s placeholders", "$QData{Name}"}'</code></td>
                    <td><code class="literal">[% Translate("Text with dynamic %s placeholders", Data.Name) | JSON %]</code></td>
                </tr><tr>
                    <td><code class="literal">"$JSText{"Text with dynamic %s placeholders", "$QData{Name}"}"</code></td>
                    <td><code class="literal">[% Translate("Text with dynamic %s placeholders", Data.Name) | JSON %]</code></td>
                </tr><tr>
                    <td><code class="literal">$TimeLong{"$Data{"CreateTime"}"}</code></td>
                    <td><code class="literal">[% Data.CreateTime | Localize("TimeLong") %]</code></td>
                </tr><tr>
                    <td><code class="literal">$TimeShort{"$Data{"CreateTime"}"}</code></td>
                    <td><code class="literal">[% Data.CreateTime | Localize("TimeShort") %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Date{"$Data{"CreateTime"}"}</code></td>
                    <td><code class="literal">[% Data.CreateTime | Localize("Date") %]</code></td>
                </tr><tr>
                    <td><code class="literal">&lt;-- dtl:block:Name --&gt;...&lt;-- dtl:block:Name --&gt;</code></td>
                    <td><code class="literal">[% RenderBlockStart("Name") %]...[% RenderBlockEnd("Name") %]</code></td>
                </tr><tr>
                    <td><code class="literal">&lt;-- dtl:js_on_document_complete --&gt;...&lt;-- dtl:js_on_document_complete --&gt;</code></td>
                    <td><code class="literal">[% WRAPPER JSOnDocumentComplete %]...[% END %]</code></td>
                </tr><tr>
                    <td><code class="literal">&lt;-- dtl:js_on_document_complete_placeholder --&gt;</code></td>
                    <td><code class="literal">[% PROCESS JSOnDocumentCompleteInsert %]</code></td>
                </tr><tr>
                    <td><code class="literal">$Include{"Copyright"}</code></td>
                    <td><code class="literal">[% InsertTemplate("Copyright") %]</code></td>
                </tr></tbody></table></div></div><br class="table-break"><p>
            There is also a helper script <code class="filename">bin/otrs.MigrateDTLtoTT.pl</code> that will automatically port
            the DTL files to Template::Toolkit syntax for you. It might fail if you have errors in your DTL, please
            correct these first and re-run the script afterwards.
        </p><p>
            There are a few more things to note when porting your code to the new template engine:
        </p><p>
            </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
                        All language files must now have the <code class="literal">use utf8;</code> pragma.
                    </p></li><li class="listitem"><p>
                        <code class="code">Layout::Get()</code> is now deprecated. Please use <code class="code">Layout::Translate()</code>
                        instead.
                    </p></li><li class="listitem"><p>
                        All occurrences of <code class="literal">$Text{""}</code> in Perl code must now be replaced by calls to
                        <code class="code">Layout::Translate()</code>.
                    </p><p>
                        This is because in DTL there was no separation between template and data. If DTL-Tags were
                        inserted as part of some data, the engine would still parse them. This is no longer the case in
                        Template::Toolkit, there is a strict separation of template and data.
                    </p><p>
                        Hint: should you ever need to interpolate tags in data, you can use the
                        <code class="literal">Interpolate</code> filter for this (<code class="literal">[% Data.Name | Interpolate
                        %]</code>). This is not recommended for security and performance reasons!
                    </p></li><li class="listitem"><p>
                        For the same reason, dynamically injected JavaScript that was enclosed by
                        <code class="literal">dtl:js_on_document_complete</code> will not work any more. Please use
                        <code class="code">Layout::AddJSOnDocumentComplete()</code> instead of injecting this as template data.
                    </p><p>
                        You can find an example for this in
                        <code class="filename">Kernel/System/DynamicField/Driver/BaseSelect.pm</code>.
                    </p></li><li class="listitem"><p>
                        Please be careful with <code class="literal">pre</code> output filters (the ones configured in
                        <code class="literal">Frontend::Output::FilterElementPre</code>). They still work, but they will prevent
                        the template from being cached. This could lead to serious performance issues. You should
                        definitely not have any <code class="literal">pre</code> output filters that operate on all templates, but
                        limit them to certain templates via configuration setting.
                    </p><p>
                        The <code class="literal">post</code> output filters
                        (<code class="literal">Frontend::Output::FilterElementPost</code>) don't have such strong negative
                        performance effects. However, they should also be used carefully, and not for all templates.
                    </p></li></ul></div><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-33-to-4-fontawesome"></a>New FontAwesome version</h4></div></div></div><p>
            With OTRS 4, we've also updated FontAwesome to a new version. As a consequence, the icons CSS classes have
            changed. While previously icons were defined by using a schema like <code class="literal">icon-{iconname}</code>, it
            is now <code class="literal">fa fa-{iconname}</code>.
        </p><p>
            Due to this change, you need to make sure to update all custom frontend module registrations which make use
            of icons (e.g. for the top navigation bar) to use the new schema. This is also true for templates where
            you're using icon elements like <code class="literal">&lt;i class="icon-{iconname}"&gt;&lt;/i&gt;</code>.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-33-to-4-unit-tests"></a>Unit Tests</h4></div></div></div><p>
            With OTRS 4, in Unit Tests <code class="literal">$Self</code> no longer provides common objects like the
            <code class="literal">MainObject</code>, for example. Please always use <code class="code">$Kernel::OM-&gt;Get('...')</code> to fetch
            these objects.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="package-porting-33-to-4-custom-ticket-history-types"></a>Custom Ticket History types</h4></div></div></div><p>
            If you use any custom ticket history types, you have to take two steps for them to be displayed correctly
            in <code class="literal">AgentTicketHistory</code> of OTRS 4+.
        </p><p>
            Firstly, you have to register your custom ticket history types via SysConfig. This could look like:
        </p><p>
            </p><pre class="programlisting">
&lt;ConfigItem Name="Ticket::Frontend::HistoryTypes###100-MyCustomModule" Required="1" Valid="1"&gt;
&lt;Description Translatable="1"&gt;Controls how to display the ticket history entries as readable values.&lt;/Description&gt;
&lt;Group&gt;Ticket&lt;/Group&gt;
&lt;SubGroup&gt;Frontend::Agent::Ticket::ViewHistory&lt;/SubGroup&gt;
&lt;Setting&gt;
    &lt;Hash&gt;
        &lt;Item Key="MyCustomType" Translatable="1"&gt;Added information (%s)&lt;/Item&gt;
    &lt;/Hash&gt;
&lt;/Setting&gt;
&lt;/ConfigItem&gt;
            </pre><p>
        </p><p>
            The second step is to translate the English text that you provided for the custom ticket history type in
            your translation files, if needed. That's it!
        </p><p>
            If you are interested in the details, please refer to
            <a class="ulink" href="https://github.com/OTRS/otrs/commit/454dfac6d4eb85652a267e5e65514e386d3cf275" target="_top">this
            commit</a> for additional information about the changes that happened in OTRS.
        </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="package-building.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="how-to-publish-extensions.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="contributing.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Package Building </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 5. Contributing to OTRS</td></tr></table></div></body></html>
