<html><head>
<!-- otrs.github.io -->
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../../../../../documentation.css">
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="../../../../../documentation.js"></script>
<link rel="icon" type="image/png" sizes="32x32" href="../../../../../../images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../../../../../images/favicon-16x16.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script>
$(document).ready(function() {

    // Hint languages to prevent false matches (php for example).
    hljs.configure({
        languages: ['perl', 'javascript', 'xml', 'html', 'css', 'json', 'yaml']
    });

    // programlistings in manuals
    $('pre.programlisting').each(function(i, block) {
        hljs.highlightBlock(block);
    });
    // code snippets in Perl API docs
    $('.pod pre').addClass('perl').each(function(i, block) {
        hljs.highlightBlock(block);
    });
});</script>
<!-- otrs.github.io -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Eメール設定</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="OTRS 5 - 管理 マニュアル"><link rel="up" href="administration.html" title="第4章 管理"><link rel="prev" href="backup-and-restore.html" title="Backing Up the System"><link rel="next" href="external-backends.html" title="Using External backends"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Eメール設定</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="backup-and-restore.html">戻る</a> </td><th width="60%" align="center">第4章 管理</th><td width="20%" align="right"> <a accesskey="n" href="external-backends.html">次へ</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a name="email-settings"></a>Eメール設定</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="email-settings.html#email">Sending/Receiving Emails</a></span></dt><dd><dl><dt><span class="section"><a href="email-settings.html#email-sending">Sending Emails</a></span></dt><dd><dl><dt><span class="section"><a href="email-settings.html#email-sending-sendmail">Via Sendmail (Default)</a></span></dt><dt><span class="section"><a href="email-settings.html#email-sending-smtp">Via SMTP Server or Smarthost</a></span></dt></dl></dd><dt><span class="section"><a href="email-settings.html#email-receiving">Receiving Emails</a></span></dt><dd><dl><dt><span class="section"><a href="email-settings.html#email-receiving-pop3">Mail Accounts Configured via the OTRS GUI</a></span></dt><dt><span class="section"><a href="email-settings.html#email-receiving-cmd">Via Command Line Program and Procmail (<code class="filename">otrs.Console.pl
Maint::PostMaster::Read</code>)</a></span></dt><dt><span class="section"><a href="email-settings.html#email-receiving-fetchmail">Fetching emails via POP3 or IMAP and fetchmail for <code class="filename">otrs.Console.pl
Maint::PostMaster::Read</code></a></span></dt><dt><span class="section"><a href="email-settings.html#email-receiving-filter">Filtering/Dispatching by OTRS/PostMaster Modules (for More Complex
Dispatching)</a></span></dt><dt><span class="section"><a href="email-settings.html#email-filter-troubleshooting">Troubleshooting Email Filtering</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="email-settings.html#configure-pgp">Secure Email with PGP</a></span></dt><dt><span class="section"><a href="email-settings.html#smime">Secure Email with S/MIME</a></span></dt><dd><dl><dt><span class="section"><a href="email-settings.html#SMIMEFetchFromCustomer">Fetch S/MIME Certificates from Customer User Backends</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="email"></a>Sending/Receiving Emails</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="email-sending"></a>Sending Emails</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="email-sending-sendmail"></a>Via Sendmail (Default)</h5></div></div></div><p>
OTRS can send out emails via <a class="ulink" href="http://www.sendmail.org/" target="_top">Sendmail</a>, <a class="ulink" href="http://www.postfix.org/" target="_top">Postfix</a>, <a class="ulink" href="http://www.qmail.org" target="_top">Qmail</a> or <a class="ulink" href="http://www.exim.org" target="_top">Exim</a>. The default configuration is to use
Sendmail and should work out-of-the-box.
</p><p>
You can configure the sendmail settings via the graphical configuration
frontend (<code class="literal">Framework::Core::Sendmail</code>)
</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="email-sending-smtp"></a>Via SMTP Server or Smarthost</h5></div></div></div><p>
OTRS can send emails via SMTP (<a class="ulink" href="http://www.ietf.org/rfc/rfc821.txt" target="_top">Simple Mail Transfer Protocol / RFC
821</a>) or Secure SMTP.
</p><p>
The SMTP server settings can be configured via the SysConfig
(<code class="literal">Framework::Core::Sendmail</code>). If you don't see SMTPS
available as an option, the required Perl modules are missing. In that case,
please refer to <a class="link" href="manual-installation-of-otrs.html#installation-of-perl-modules" title="ステップ2：Perlモジュールの追加インストール">"Installation
of Perl modules required for OTRS"</a> for instructions.
</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="email-receiving"></a>Receiving Emails</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="email-receiving-pop3"></a>Mail Accounts Configured via the OTRS GUI</h5></div></div></div><p>
OTRS is able to receive emails from POP3, POP3S, IMAP and IMAPS mail
accounts.
</p><p>
Configure your mail accounts via the "PostMaster Mail Accounts" link on the
Admin page.
</p><p>
If a new mail account is to be created (see figure below), then its mail
server name, login name and password must be specified. Also, you need to
select the mail server type, which can be POP3, POP3S, IMAP or IMAPS. If you
don't see your server type available as an option, the required Perl modules
are missing on your system. In that case, please refer to <a class="link" href="manual-installation-of-otrs.html#installation-of-perl-modules" title="ステップ2：Perlモジュールの追加インストール"> "Installation of Perl modules
required for OTRS"</a> for instructions.</p><p>
</p><div class="figure"><a name="id-1.6.5.2.3.2.5.1"></a><p class="title"><b>図4.66 メールアカウントの追加。</b></p><div class="figure-contents"><div class="screenshot"><div><img src="screenshots/administration/email/add-mailaccount.png" alt="メールアカウントの追加。"></div></div></div></div><p><br class="figure-break">
</p><p>信頼済オプションの値にYesを選べば、受信メッセージに付けられたどんなX-OTRSヘッダーも評価され実行されます。X-OTRSヘッダーがチケットシステムの中のいくつかのアクションを実行することができるので既知の送信者だけに信頼済オプションをYesにセットするべきです。X-OTRSヘッダーはOTRSでは<a class="link" href="administration.html#adminarea-postmasterfilter" title="受信Eメール・メッセージのフィルタリング">フィルタ・モジュール</a>によって使用されます。X-OTRSヘッダーは、<a class="link" href="administration.html#table-of-x-otrs-headers" title="表4.5 異なるX-OTRSヘッダーの機能">このテーブルの中で</a>より詳細に説明されます。作成されたどんなpostmasterフィルタ規則も、信頼されたオプションのセッティングに関係なく実行されます。
</p><p>
The distribution of incoming messages can be controlled if they need to be
sorted by queue or by the content of the "To:" field. For the Dispatching
field, if "Dispatching by selected queue" is selected, all incoming messages
will be sorted into the specified queue. The address where the mail was sent
to is disregarded in this case. If "Dispatching by email To: field" is
selected, the system checks if a queue is linked with the address in the To:
field of the incoming mail. You can link an address to a queue in the <a class="link" href="administration.html#adminarea-emailaddresses" title="システム・メール・アドレス">E-mail address management</a> section
of the Admin page. If the address in the To: field is linked with a queue,
the new message will be sorted into the linked queue. If no link is found
between the address in the To: field and any queue, then the message flows
into the "Raw" queue in the system, which is the <a class="link" href="ConfigReference_Ticket.html#ConfigReference_Ticket:Core::PostMaster:PostmasterDefaultQueue">PostmasterDefaultQueue</a>
after a default installation.
</p><p>
All data for the mail accounts are saved in the OTRS database. The
<code class="filename">bin/otrs.Console.pl Maint::PostMaster::MailAccountFetch</code>
command uses the settings in the database and fetches the mail. You can
execute it manually to check if all your mail settings are working properly.
</p><p>
On a normal installation, the mail will be fetched every 10 minutes by the
OTRS Daemon.
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>
メールを取って来る場合、OTRSはPOPかIMAPサーバーからメールを削除します。さらにサーバ上でコピーを保存するオプションはありません。サーバのコピーを保持したければ、メールサーバで転送規則を作成するとよいでしょう。詳細のためにメールサーバ・ドキュメンテーションを調べてください。
</p></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="email-receiving-cmd"></a>Via Command Line Program and Procmail (<code class="filename">otrs.Console.pl
Maint::PostMaster::Read</code>)</h5></div></div></div><p>
If you cannot use mail accounts to get the email into OTRS, the command line
program <code class="filename">bin/otrs.Console.pl Maint::PostMaster::Read</code>
might be a way around the problem. It takes the mails via STDIN and pipes
them directly into OTRS. That means email will be available in your OTRS
system if the MDA (mail delivery agent, e.g. procmail) executes this
program.
</p><p>
To test <code class="filename">bin/otrs.Console.pl Maint::PostMaster::Read</code>
without an MDA, execute the command of the following script.
</p><p>
</p><pre class="screen">
linux:/opt/otrs# cd bin
linux:/opt/otrs/bin# cat ../doc/sample_mails/test-email-1.box | ./otrs.Console.pl Maint::PostMaster::Read
linux:/opt/otrs/bin#
</pre><p>
</p><p>
<span class="emphasis"><em>スクリプト:MDAのないポストマスターのテスト</em></span>
</p><p>
EメールがQueueViewの中で表示される場合、あなたの設定は正しく動作しています。
</p><div class="example"><a name="procmail-queue-routing"></a><p class="title"><b>例4.2 Routing via Procmail Using <code class="filename">otrs.Console.pl</code></b></p><div class="example-contents"><p>
In order to route mails in a specific queue using
<code class="filename">otrs.Console.pl</code> use the following example.
</p><p>
</p><pre class="screen">
| $SYS_HOME/bin/otrs.Console.pl Maint::PostMaster::Read --target-queue=QUEUENAME
</pre><p>
</p><p>
When sorting to a subqueue, you must separate the parent and child queue
with a <code class="literal">::</code>.
</p><p>
</p><pre class="screen">
| $SYS_HOME/bin/otrs.Console.pl Maint::PostMaster::Read --target-queue=QUEUENAME::SUBQUEUE
</pre><p>
</p></div></div><br class="example-break"><p>
ProcmailはLinux環境中でとても普及しているEメール・フィルタです。ほとんどのシステムにそれがインストールされます。そうでなければ、<a class="ulink" href="http://www.procmail.org/" target="_top"><em class="citetitle">procmailホームページ</em></a>を見てください。
</p><p>
OTRS用にprocmailを構成するためには(sendmail、postfix、eximあるいはqmailといったprocmail構成のMTAに基づいた）、<code class="filename">~otrs/.procmailrc.dist</code>ファイルを使用して、<code class="filename">.procmailrc</code>にそれをコピーして、スクリプトのラインを下に加えてください。
</p><p>
</p><pre class="programlisting">
SYS_HOME=$HOME
PATH=/bin:/usr/bin:/usr/local/bin
# --
# Pipe all email into the PostMaster process.
# --
:0 :
| $SYS_HOME/bin/otrs.Console.pl Maint::PostMaster::Read
</pre><p>
</p><p>
<span class="emphasis"><em>スクリプト:OTRSのためのprocmailの構成。</em></span>
</p><p>
All email sent to the local OTRS user will be piped into
<code class="filename">bin/otrs.Console.pl Maint::PostMaster::Read</code> and then
shown in your QueueView.
</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="email-receiving-fetchmail"></a>Fetching emails via POP3 or IMAP and fetchmail for <code class="filename">otrs.Console.pl
Maint::PostMaster::Read</code></h5></div></div></div><p>
In order to get email from your mail server, via a POP3 or IMAP mailbox, to
the OTRS machine/local OTRS account and to procmail, use <a class="ulink" href="http://www.fetchmail.info/" target="_top">fetchmail</a>.
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>
OTRSマシン上で作動してるSMTP構成が必要です。
</p></div><p>
You can use the <code class="filename">.fetchmailrc.dist</code> in the home directory
of OTRS and copy it to <code class="filename">.fetchmailrc</code>. Modfiy/change it
for your needs (see the Example below).
</p><div class="example"><a name="fetchmailrc"></a><p class="title"><b>例4.3 <code class="literal">.fetchmailrc</code></b></p><div class="example-contents"><p>
</p><pre class="programlisting">
#poll (mailserver) protocol POP3 user (user) password (password) is(localuser)
poll mail.example.com protocol POP3 user joe password mama is otrs
</pre><p>
</p></div></div><br class="example-break"><p>
<code class="filename">.fetchmailrc</code> のパーミッションを 710 にする(<span class="command"><strong>chmod 710
.fetchmailrc</strong></span>を実行する)のを忘れないでください！
</p><p>
With the <code class="filename">.fetchmailrc</code> from the Example above, all email
will be forwarded to the local OTRS account, if the command
<span class="command"><strong>fetchmail -a</strong></span> is executed. Set up a cronjob with this
command if you want to fetch the mails regularly.
</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="email-receiving-filter"></a>Filtering/Dispatching by OTRS/PostMaster Modules (for More Complex
Dispatching)</h5></div></div></div><p>
If you use the <code class="filename">bin/otrs.Console.pl
Maint::PostMaster::Read</code> or <code class="filename">bin/otrs.Console.pl
Maint::PostMaster::MailAccountFetch</code> method, you can insert or
modify X-OTRS header entries with the PostMaster filter modules. With the
X-OTRS headers, the ticket system can execute some actions on incoming
mails, sort them into a specific queue, change the priority or change the
customer ID, for example. More information about the X-OTRS headers are
available in the section about <a class="link" href="administration.html#adminarea-postmasterpop3-account" title="Eメールアカウントの使用">adding mail accounts</a> from
the OTRS Admin page.
</p><p>
いくつかのデフォルト・フィルタ・モジュールがあります:
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>
ジョブ名 (e.g. $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'JobName'})
はユニークである必要があります。
</p></div><p>
<code class="literal">Kernel::System::PostMaster::Filter::Match</code> is a default
module to match on some email header (e.g. From, To, Subject, ...). It can
set new email headers (e.g. X-OTRS-Ignore: yes or X-OTRS-Queue: spam) if a
filter rule matches. The jobs of the Example below can be inserted in
<code class="filename">Kernel/Config.pm</code>
</p><div class="example"><a name="filter-module-match-example"></a><p class="title"><b>例4.4 Example jobs for the filter module
<code class="literal">Kernel::System::PostMaster::Filter::Match</code></b></p><div class="example-contents"><p>
</p><pre class="programlisting">
    # Job Name: 1-Match
    # (noreply@からの全てのスパムEメールをブロックまたは無視)
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'1-Match'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::Match',
        Match =&gt; {
            From =&gt; 'noreply@',
        },
        Set =&gt; {
            'X-OTRS-Ignore' =&gt; 'yes',
        },
    };
    # Job Name: 2-Match
    # (件名: **ORDER**かつsales@example.comからのEメールをソート)
    # into queue 'Order')
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'2-Match'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::Match',
        Match =&gt; {
            To =&gt; 'sales@example.com',
            Subject =&gt; '**ORDER**',
        },
        Set =&gt; {
            'X-OTRS-Queue' =&gt; 'Order',
        },
    };
</pre><p>
</p></div></div><br class="example-break"><p>
<code class="literal">Kernel::System::PostMaster::Filter::CMD</code> is a default
module to pipe the email into an external command. The output is given to
STDOUT and if the result is true, then set new email header
(e.g. X-OTRS-Ignore: yes or X-OTRS-Queue: spam). The Example below can be
used in <code class="filename">Kernel/Config.pm</code>
</p><div class="example"><a name="filter-module-cmd-example"></a><p class="title"><b>例4.5 フィルタ・モジュールのためのサンプル・ジョブ　Kernel::System::PostMaster::Filter::CMD</b></p><div class="example-contents"><p>
</p><pre class="programlisting">
    # Job Name: 5-SpamAssassin
    # (SpamAssassin サンプルセットアップ, スパムメールを無視します)
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'5-SpamAssassin'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::CMD',
        CMD =&gt; '/usr/bin/spamassassin | grep -i "X-Spam-Status: yes"',
        Set =&gt; {
            'X-OTRS-Ignore' =&gt; 'yes',
        },
    };
</pre><p>
</p></div></div><br class="example-break"><p>
    <code class="literal">Kernel::System::PostMaster::Filter::ExternalTicketNumberRecognition</code>
is a default module that adds the possibility to parse external identifiers,
in the email subject, the body or both using regular expressions. It then
stores this value in a defined dynamic field. When an email comes in, OTRS
will first search for an external identifier and when it finds one, query
OTRS on the pre-defined dynamic field. If it finds an existing ticket, it
will update this ticket, otherwise it will create a new ticket with the
external reference number in the separate field.
</p><p>
    OTRS SysConfig already provide 4 different settings to setup different
external ticket numbers.  If more settings are needed they need to be added
manually. The following example can be used in
<code class="filename">Kernel/Config.pm</code> to extend SysConfig settings.
</p><div class="example"><a name="filter-module-externalticketrecognition-example"></a><p class="title"><b>例4.6 
        Example job for the filter module
<code class="literal">Kernel::System::PostMaster::Filter::ExternalTicketNumberRecognition</code>
    </b></p><div class="example-contents"><pre class="programlisting">
    # Job Name: ExternalTicketNumberRecognition
    # External Ticket Number Reconition, check for Incident-&lt;number&gt; in incoming mails subject and
    # body from the addeesses &lt;sender&gt;@externalticket.com, if number is found it will be stored in
    # the dynamic field 'ExternalNumber' (that need to be setup in the Admin Panel).
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'000-ExternalTicketNumberRecognition'} = {
        'FromAddressRegExp' =&gt; '\\s*@externalticket.com',
        'NumberRegExp'      =&gt; 'Incident-(\\d.*)',
        'SearchInSubject'   =&gt; '1',
        'SearchInBody'      =&gt; '1',
        'TicketStateTypes'  =&gt; 'new;open'
        'DynamicFieldName'  =&gt; 'ExternalNumber',
        'Module'            =&gt; 'Kernel::System::PostMaster::Filter::ExternalTicketNumberRecognition',
        'Name'              =&gt; 'Test External Ticket Number',
        'SenderType'        =&gt; 'system',
    };
    </pre></div></div><br class="example-break"><div class="itemizedlist"><p><span class="emphasis"><em>構成オプション</em></span></p><ul class="itemizedlist" type="round"><li class="listitem"><p>FromAddressRegExp</p><p>
            これはオプションの設定です。この「From:」アドレスと一致しているメールだけがこのフィルターで考慮されます。この設定を調整して、送信メール用外部システム利用を、送信者アドレスにすることができます。このアドレスが異なる場合、このオプションを空にすることができます。この場合、OTRSは送信者アドレスをチェックしません。
        </p></li><li class="listitem"><p>NumberRegExp</p><p>
            これは必須設定項目です。この設定は　件名またはチケットの本文からチケット番号を抽出するためにOTRSが使う正規表現を含みます。デフォルトの正規表現は　以下のような例の発生と一致するでしょう。例えば「Incident-12354」そしてその部分を動的フィールド中に括弧で挟む部分を置きます（ここでは「12354」）
        </p></li><li class="listitem"><p>SearchInSubject</p><p>これが「1」にセットされる場合、Eメール件名はチケット番号を求めて検索されます。</p></li><li class="listitem"><p>SearchInBody</p><p>これが「1」にセットされる場合、Eメール本文はチケット番号を求めて検索されます。</p></li><li class="listitem"><p>TicketStateTypes（チケット・状態・タイプ）</p><p>
            これはオプションの設定です。もし与えられれば、それは与えられた状態タイプの開いた外部チケットのみOTRSを検索するでしょう。状態タイプはセミコロンで分離されます。
        </p></li><li class="listitem"><p>DynamicField</p><p>
            これは必須の設定で、外部番号を保存するために使われている動的フィールドを定義します。(フィールド名はシステムに存在しなければいけないしかつ有効でなければなりません)
        </p></li><li class="listitem"><p>SenderType</p><p>これは、OTRSで記事作成に使用される送信者タイプを定義します。</p></li></ul></div><p>
    <code class="literal">Kernel::System::PostMaster::Filter::Decrypt</code> is a default
module that is capable to decrypt an encrypted incoming email message
(S/MIME or PGP) placing the unencrypted message body in the email header
X-OTRS-BodyDecrypted to be processed later.  Additionally it can also update
the email body to the unencrypted version.
</p><p>
    In order to decrypt the emails the system needs to be properly configured
for S/MIME and/or PGP and have the needed private keys to decrypt the
information.
</p><p>
    This module is disabled by default and it can be configured directly in the
System Configuration in the Admin Panel.
</p><div class="itemizedlist"><p><span class="emphasis"><em>構成オプション</em></span></p><ul class="itemizedlist" type="round"><li class="listitem"><p>StoreDecryptedBody</p><p>
            Set this option to "1" to update the email body to the unencrypted version
if the decryption was successful. Be aware that using this the emails will
be stored unencrypted and there is no possible way to revert this action.
        </p></li></ul></div><p>
もちろん、自分のPostMasterフィルタ・モジュールを開発することも可能です。
</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="email-filter-troubleshooting"></a>Troubleshooting Email Filtering</h5></div></div></div><p>This section shows some common issues and things to consider when
troubleshooting Postmaster filters.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>The filters are worked in order of their alphabetically sorted filter
names. The last filter wins for a certain field to be set, when the criteria
match twice.</p></li><li class="listitem"><p>"Stop After Match" can prevent a second match.</p></li><li class="listitem"><p>Make sure the regular expression is valid.</p></li><li class="listitem"><p>Headers can be set as to control OTRS, but are not written in the mail
itself.</p></li><li class="listitem"><p>When matching one From, CC, TO, use EMAILADDRESS: &lt;your@address&gt;</p></li><li class="listitem"><p>The Mailbox must be trusted.</p></li><li class="listitem"><p>The match criteria are AND conditions.</p></li><li class="listitem"><p>Ticket properties can not be matched by the postmaster filter.</p></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configure-pgp"></a>Secure Email with PGP</h3></div></div></div><p>
OTRSは、PGP鍵を備えた送信メッセージに署名するか暗号化する能力を持っています。更に、暗号化された受信メッセージは解読することができます。暗号化と解読はGPLツールGnuPGで実施されます。OTRSのためのセットアップGnuPGに、次のステップを行なわなければなりません。
</p><p>
</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
    オペレーティング・システムのパッケージ・マネージャーによるGnuPGのインストール
    </p></li><li class="listitem"><p>
    OTRSで使うGnuPGを構成してください。GnuPGと秘密鍵のための必要なディレクトリを作成しなければなりません。シェルからユーザ「otrs」としてスクリプト中で下に示されるコマンドを実行しなければなりません。
    </p><p>
    </p><pre class="screen">
    linux:~# su otrs
    linux:/root$ cd
    linux:~$ pwd
    /opt/otrs
    linux:~$ gpg --gen-key
    gpg (GnuPG) 1.4.2; Copyright (C) 2005 Free Software Foundation, Inc.
    This program comes with ABSOLUTELY NO WARRANTY.
    This is free software, and you are welcome to redistribute it
    under certain conditions. See the file COPYING for details.

    gpg: directory `/opt/otrs/.gnupg' created
    gpg: new configuration file `/opt/otrs/.gnupg/gpg.conf' created
    gpg: WARNING: options in `/opt/otrs/.gnupg/gpg.conf' are not yet active during t
    his run
    gpg: keyring `/opt/otrs/.gnupg/secring.gpg' created
    gpg: keyring `/opt/otrs/.gnupg/pubring.gpg' created
    Please select what kind of key you want:
       (1) DSA and Elgamal (default)
       (2) DSA (sign only)
       (5) RSA (sign only)
    Your selection? 1
    DSA keypair will have 1024 bits.
    ELG-E keys may be between 1024 and 4096 bits long.
    What keysize do you want? (2048)
    Requested keysize is 2048 bits
    Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
    Key is valid for? (0)
    Key does not expire at all
    Is this correct? (y/N) y

    You need a user ID to identify your key; the software constructs the user ID
    from the Real Name, Comment and Email Address in this form:
        "Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;"

    Real name: Ticket System
    Email address: support@example.com
    Comment: Private PGP Key for the ticket system with address support@example.com
    You selected this USER-ID:
    "Ticket System (Private PGP Key for the ticket system with address support@examp
    le.com) &lt;support@example.com&gt;"

    Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
    You need a Passphrase to protect your secret key.

    Passphrase: secret
    Repeat passphrase: secret

    We need to generate a lot of random bytes. It is a good idea to perform
    some other action (type on the keyboard, move the mouse, utilize the
    disks) during the prime generation; this gives the random number
    generator a better chance to gain enough entropy.
    ++++++++++.+++++++++++++++++++++++++....+++++.+++++...+++++++++++++++++++++++++.
    +++++++++++++++++++++++++.+++++.+++++.+++++++++++++++++++++++++&gt;++++++++++&gt;+++++
    .......&gt;+++++&lt;+++++................................+++++

    Not enough random bytes available.  Please do some other work to give
    the OS a chance to collect more entropy! (Need 280 more bytes)

    ++++++++++.+++++..++++++++++..+++++....++++++++++++++++++++.+++++++++++++++.++++
    ++++++++++++++++++++++++++.++++++++++.+++++++++++++++.++++++++++.+++++++++++++++
    ..+++++&gt;.+++++....&gt;+++++........................................................
    ...........................................................&gt;+++++&lt;+++++.........
    .............+++++^^^
    gpg: /opt/otrs/.gnupg/trustdb.gpg: trustdb created
    gpg: key 7245A970 marked as ultimately trusted
    public and secret key created and signed.

    gpg: checking the trustdb
    gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
    gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
    pub   1024D/7245A970 2006-02-03
          Key fingerprint = 2ED5 BC36 D2B6 B055 7EE1  5833 1D7B F967 7245 A970
     uid                  Ticket System (Private pgp key for ticket system with addre
    ss support@example.com) &lt;support@example.com&gt;
    sub   2048g/52B97069 2006-02-03

    linux:~$
    </pre><p>
    </p><p>
    <span class="emphasis"><em>スクリプト: GnuPGの構成</em></span>
    </p><p>
        スクリプトの中で下に示されるように、デフォルト構成は、ほとんどの要求されるパラメタのために適用することができます。キーに指定された適切なパスワードで、key所有者に対する値だけを正確に入力しなければなりません。
    </p></li><li class="listitem"><p>
    <a class="link" href="ConfigReference_Framework.html#ConfigReference_Framework:Crypt::PGP" title="Framework → Crypt::PGP">PGP</a>
の設定画面では、PGPはOTRSで有効になっており(一つ目のオプション)、また、PGPプログラムへのパスが設定され、有効になっている必要があります
    </p><p>
    次の構成設定(PGP::Options)はさらに変わることを要求するかもしれません。このコンフィグ・セッティングによって、「otrs」ユーザによってgpgのすべての実行に使用されるパラメタは指定することができます。特に「otrs」ユーザのGnuPGのための構成ファイルのディレクトリは重要です。例<code class="filename">/opt/otrs/.gnupg</code>の中で、使用されます。このディレクトリは、PGP鍵構成以前に作成されました。
    </p><p>
        次の構成オプション(PGP::Key::Password)によって、キーIDのペアおよび自身の秘密鍵のパスワードを指定することは可能です、なぜなら、外部からのコミュニケーションパートナーチケットシステムに彼らのメッセージを暗号化と秘密鍵で書き込み、OTRSはそれらのメッセージをIDとパスワードをここで指定して解読するからです。
    </p><p>
    どのようにしてあなた自身の秘密鍵のIDを得ることができますか？あなた自身の秘密鍵のIDはすでにキー生成時に表示されています。（上記ステップ１をご覧ください）さらに、次のスクリプト中で指定されたコマンドがユーザ「otrs」として実行される場合、IDを得ることが可能です:
    </p><p>
    </p><pre class="screen">
    linux:~# su otrs
    linux:/root$ cd
    linux:~$ pwd
    /opt/otrs
    linux:~$ gpg --list-keys
    /opt/otrs/.gnupg/pubring.gpg
    ----------------------------
    pub   1024D/7245A970 2006-02-03
    uid                  Ticket System (Private pgp key for ticket system with
    address support@example.com) &lt;support@example.com&gt;
    sub   2048g/52B97069 2006-02-03

    linux:~$
    </pre><p>
    </p><p>
    <span class="emphasis"><em>スクリプト:自分の秘密鍵のIDを得ること。</em></span>
    </p><p>
    秘密鍵のIDは、「サブ」で始まるラインで見つけることができます。それは長さ8文字で16進法の文字列で上の例では「52B97069」です。チケットシステムでこのキー用に指定しなければならないパスワードは、キー生成中に与えられたのと同じです。
    </p><p>
    このデータが挿入された後、「アップデート」ボタンはセッティングを保存するために使用することができます。これでOTRSは暗号化されたメッセージを受け取り解読する準備ができています。
    </p></li><li class="listitem"><p>
    このデータが挿入された後、「アップデート」ボタンはセッティングを保存するために使用することができます。これでOTRSは暗号化されたメッセージを受け取り解読する準備ができています。
    </p><p>
    最初の方法は、顧客管理インターフェースで顧客の公開鍵を指定することです。
    </p><p>
    第2の方法は、PGP鍵設定(管理者ページから到達可能)によってキーを指定することです。この画面の右側のセクションにおいては、すでにインポート済の顧客の公開鍵が全て表示されます。PGP鍵がOTRSのために活性化され構成されたら、自分の公開鍵もそこにリストされるべきです。PGP鍵設定画面の左のエリアでキーを探せます。さらに、新規公開鍵はファイルからシステムへアップロードすることができます。
    </p><p>
    OTRSへインポートされる必要のある公開鍵を備えたファイルはGnuPGP互換性をもつキー・ファイルでなければなりません。ほとんどの場合、ファイルに格納されたキーは「ASCII
armored key」です。OTRSはこのフォーマットを取り扱えます。
    </p></li></ol></div><p>
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="smime"></a>Secure Email with S/MIME</h3></div></div></div><p>
一見、S/MIMEを備えた暗号化はPGP鍵を備えた暗号化より少し複雑に見えます。最初に、OTRSシステムのために認証局(CA)を設立しなければなりません。後のステップは、PGP鍵で必要とされるものに非常に似ています:OTRSの構成、自身の証明書のインストール、必要な他の証明書のインポート等。
</p><p>
S/MIME構成は、大部分はOTRSウェブインターフェースの外部で行われ、「otrs」ユーザによってシェルの中で実行されるべきです。Linux下のMIME構成SSL(OpenSSL)に基づきます。したがって、あなたのシステムにOpenSSLパッケージがインストールされるかどうかを第一にチェックしてください。OpenSSLパッケージは、CA.pl(証明書生成の最も重要なステップはそれで行なうことができます)と呼ばれるスクリプトを含んでいます。手続きを単純化するために、ファイルシステムでCA.plスクリプトが保存され、シェルのパス変数に一時的に位置を入力する場所を見つけます。(下記のスクリプトを参照)
</p><p>
</p><pre class="screen">
otrs@linux:~&gt; rpm -ql openssl | grep CA
/usr/share/ssl/misc/CA.pl
otrs@linux:~&gt; export PATH=$PATH:/usr/share/ssl/misc
otrs@linux:~&gt; which CA.pl
/usr/share/ssl/misc/CA.pl
otrs@linux:~&gt; mkdir tmp; cd tmp
otrs@linux:~/tmp&gt;
</pre><p>
</p><p>
<span class="emphasis"><em>スクリプト:S/MIMEの構成</em></span>
</p><p>
上記のスクリプトは、新規一時ディレクトリ~/tmpが作成されたことを表示しています。証明書はその中で生成されることになっています。
</p><p>
証明書を作成するためには、コマンドライン中から次のオペレーションを行なってください:(我々は、OTRS管理者がテスト用のSSL証明書および学習する目的を作成しなければならないと考えます。暗号化用の保証されたSSL証明書を既に持った場合それを使用して、これらのステップをスキップしてください。)
</p><p>
</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
    SSLのために自分の認証局を開設してください。自分のSSL証明書の要請を証明するためにそれを必要とする(下記のスクリプトを参照)。
    </p><p>
    </p><pre class="screen">
otrs@linux:~/tmp&gt; CA.pl -newca
CA certificate filename (or enter to create)

Making CA certificate ...
Generating a 1024 bit RSA private key
...++++++
......++++++
writing new private key to './demoCA/private/cakey.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:DE
State or Province Name (full name) [Some-State]:OTRS-state
Locality Name (eg, city) []:OTRS-town
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Your company
Organizational Unit Name (eg, section) []:
Common Name (eg, YOUR name) []:OTRS Admin
Email Address []:otrs@your-domain.tld
otrs@linux:~/tmp&gt; ls -la demoCA/
total 8
-rw-r--r--  1 otrs otrs 1330 2006-01-08 17:54 cacert.pem
drwxr-xr-x  2 otrs otrs   48 2006-01-08 17:53 certs
drwxr-xr-x  2 otrs otrs   48 2006-01-08 17:53 crl
-rw-r--r--  1 otrs otrs    0 2006-01-08 17:53 index.txt
drwxr-xr-x  2 otrs otrs   48 2006-01-08 17:53 newcerts
drwxr-xr-x  2 otrs otrs   80 2006-01-08 17:54 private
-rw-r--r--  1 otrs otrs   17 2006-01-08 17:54 serial
otrs@linux:~/tmp&gt;
    </pre><p>
    </p><p>
    <span class="emphasis"><em>スクリプト:　SSLのために認証局を設立</em></span>
    </p></li><li class="listitem"><p>
    証明書リクエストを生成してください(下記のスクリプトを参照)
    </p><p>
    </p><pre class="screen">
otrs@linux:~/tmp&gt; CA.pl -newreq
Generating a 1024 bit RSA private key
..........................................++++++
....++++++
writing new private key to 'newreq.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:DE\keyreturn
State or Province Name (full name) [Some-State]:OTRS-state
Locality Name (eg, city) []:OTRS-town
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Your company
Organizational Unit Name (eg, section) []:
Common Name (eg, YOUR name) []:OTRS admin
Email Address []:otrs@your-domain.tld

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
Request (and private key) is in newreq.pem
otrs@linux:~/tmp&gt; ls -la
total 4
drwxr-xr-x  6 otrs otrs  232 2006-01-08 17:54 demoCA
-rw-r--r--  1 otrs otrs 1708 2006-01-08 18:04 newreq.pem
otrs@linux:~/tmp&gt;
    </pre><p>
    </p><p>
    <span class="emphasis"><em>スクリプト:　証明書リクエストの作成</em></span>
    </p></li><li class="listitem"><p>
    証明書リクエストは署名され、それによってあなた自身のCAに証明されます。あるいは別の外部の保証されたCAによって署名されることによりさらに信頼性を高められます。（下記スクリプト参照）
    </p><p>
    </p><pre class="screen">
otrs@linux:~/tmp&gt; CA.pl -signreq
Using configuration from /etc/ssl/openssl.cnf
Enter pass phrase for ./demoCA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number:
            fd:85:f6:9f:14:07:16:c8
        Validity
            Not Before: Jan  8 17:04:37 2006 GMT
            Not After : Jan  8 17:04:37 2007 GMT
        Subject:
            countryName               = DE
            stateOrProvinceName       = OTRS-state
            localityName              = OTRS-town
            organizationName          = Your Company
            commonName                = OTRS administrator
            emailAddress              = otrs@your-domain.tld
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            Netscape Comment:
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier:
                01:D9:1E:58:C0:6D:BF:27:ED:37:34:14:D6:04:AC:C4:64:98:7A:22
            X509v3 Authority Key Identifier:
                keyid:10:4D:8D:4C:93:FD:2C:AA:9A:B3:26:80:6B:F5:D5:31:E2:8E:DB:A8
                DirName:/C=DE/ST=OTRS-state/L=OTRS-town/O=Your Company/
                CN=OTRS admin/emailAddress=otrs@your-domain.tld
                serial:FD:85:F6:9F:14:07:16:C7

Certificate is to be certified until Jan  8 17:04:37 2007 GMT (365 days)
Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
Signed certificate is in newcert.pem
otrs@linux:~/tmp&gt;
    </pre><p>
    </p><p>
    <span class="emphasis"><em>スクリプト:証明書リクエストの署名</em></span>
    </p></li><li class="listitem"><p>
    あなた自身の証明書を生成して下さい。そしてそれに伴い、署名された証明書を使う、すべてのデータを生成して下さい。（下記スクリプト参照）
    </p><p>
    </p><pre class="screen">
otrs@linux:~/tmp&gt; CA.pl -pkcs12 "OTRS Certificate"
Enter pass phrase for newreq.pem:
Enter Export Password:
Verifying - Enter Export Password:
otrs@linux:~/tmp&gt; ls -la
total 12
drwxr-xr-x  6 otrs otrs  328 2006-01-08 18:04 demoCA
-rw-r--r--  1 otrs otrs 3090 2006-01-08 18:13 newcert.p12
-rw-r--r--  1 otrs otrs 3791 2006-01-08 18:04 newcert.pem
-rw-r--r--  1 otrs otrs 1708 2006-01-08 18:04 newreq.pem
otrs@linux:~/tmp&gt;
    </pre><p>
    </p><p>
    <span class="emphasis"><em>スクリプト:新規証明書の生成</em></span>
    </p></li></ol></div><p>
</p><p>
今、これらのオペレーションが実行され、S/MIMEセットアップはOTRSの中で完成したはずです。
</p><p>
セットアップのこの部分はリンク<a class="link" href="administration.html#adminarea-smime" title="S/MIME">"SMIME"</a>を選んで、管理者ページで実行されます。OTRSで一般的なS/MIMEサポートがまだ可能にされてない場合、マスク(mask)は管理者にこれを指摘し、それを可能にするために適切なリンクを提供します。
</p><p>
SysConfig group で<a class="link" href="ConfigReference_Framework.html#ConfigReference_Framework:Crypt::SMIME" title="Framework → Crypt::SMIME">"Crypt::SMIME"</a>
S/MIME に関する全般の設定が行えます
</p><p>
ここで、S/MIME支援を活性化し、OpenSSLコマンド用のパスおよび証明書用のディレクトリーを定義することができます。上に作成されたキー・ファイルは、ここで示されたディレクトリーに格納されなければいけません。そうでなければ、OpenSSLは使用できません。
</p><p>
次のステップは<a class="link" href="administration.html#adminarea-smime" title="S/MIME">OTRS管理ページ上のS/MIME構成</a>で行われます。ここで、OTRSシステムの秘密鍵および他のコミュニケーション・パートナーの公開鍵(複数)をインポートすることができます。このセクションの最初に作成し、OTRSに追加した公開鍵を入力してください。
</p><p>
言うまでもなく、コミュニケーション・パートナーの全てのパブリックS/MIMEキーは<a class="link" href="administration.html#adminarea-customers" title="顧客">顧客管理ツール</a>を使用してインポートすることもできます。
</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="SMIMEFetchFromCustomer"></a>Fetch S/MIME Certificates from Customer User Backends</h4></div></div></div><p>
        It is possible to use a Customer User Backed (such as LDAP) as the source of
public S/MIME certificates. This certificates could be imported into the
system and be displayed in <a class="link" href="administration.html#adminarea-smime" title="S/MIME">S/MIME
configuration on the OTRS Admin page</a> and they can be used from OTRS
to send encrypted emails to the customers.
    </p><p>
        In order to enable this feature is needed to:
    </p><p>
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Enable <code class="literal">SMIME</code> in SysConfig</p></li><li class="listitem"><p>Enable <code class="literal">SMIME::FetchFromCustomer</code> in SysConfig</p></li><li class="listitem"><p>
                    Configure a customer user backend to provide the attribute
<code class="literal">UserSMIMECertificate</code> with the customer user S/MIME
certificate (there is an example for LDAP customer user mapping in
<code class="filename">$OTRS_HOME/Kernel/Config/Defaults.pm</code>).
                </p></li></ol></div><p>
    </p><p>
        This feature can be used in three different ways:
    </p><p>
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
                    Incoming Emails:
                </p><p>
                    A dedicated Postmaster filter
(<code class="literal">PostMaster::PreFilterModule###000-SMIMEFetchFromCustomer</code>
in SysConfig) will extract the email address of each incoming email and will
try to find the email address is the list of customers. If found it will try
get the S/MIME certificate from customer user attributes. If a certificate
is found it will try to import it (unless it was already imported).
                </p></li><li class="listitem"><p>
                    Specific email address or all customers:
                </p><p>
                    The console command
<code class="literal">Maint::SMIME::CustomerCertificate::Fetch</code> can be used to
import the S/MIME certificate of one customer email address as:
                </p><p>
                    </p><pre class="screen">
shell&gt; perl /opt/otrs/bin/otrs.Console.pl Maint::SMIME::CustomerCertificate::Fetch --email customer@example.com
                    </pre><p>
                </p><p>
                    In this case the console command will try to match the supplied email
address with one of the customer users. If found it will try add to the
system the S/MIME certificate found in customer user properties (if the
certificate is not already added).
                </p><p>
                    The same console command can be used to import the S/MIME certificates of
all customer users (limited to
<code class="literal">CustomerUserSearchListLimit</code> property from the customer
user backend). This option is discouraged specially for systems with a large
number of customer users as it might require too much time to execute and
depending on the limit it might be possible that not all customer
certificates will be fetch. Execute the console command in this mode as:
</p><pre class="screen">
shell&gt; perl /opt/otrs/bin/otrs.Console.pl Maint::SMIME::CustomerCertificate::Fetch --add-all
                    </pre><p>
                </p><p>
                    For this option the console command will query the customer user backends to
get all possible customers and for each it will check if there is a S/MIME
certificate. If a certificate is found, it will try to add it to the system
(if the certificate is not already added).
                </p></li><li class="listitem"><p>
                    Renew existing certificates:
                </p><p>
                    Another console command
<code class="literal">Maint::SMIME::CustomerCertificate::Renew</code> can be used to
check for all existing certificates in the system. This verifies that the
existing certificates from customer users matches the ones that are
retrieved by the customer user properties. Any new certificate in the
customer user backend will be added into the system (no certificates are
deleted in this process).
                </p><p>
                    This console command is executed once a day by the OTRS daemon automatically
with the task
<code class="literal">Daemon::SchedulerCronTaskManager::Task###RenewCustomerSMIMECertificates</code>
(as seen in SysConfig), but it can be also executed manually on demand as:
                </p><p>
                    </p><pre class="screen">
shell&gt; perl /opt/otrs/bin/otrs.Console.pl Maint::SMIME::CustomerCertificate::Renew
                    </pre><p>
                </p></li></ol></div><p>
    </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="backup-and-restore.html">戻る</a> </td><td width="20%" align="center"><a accesskey="u" href="administration.html">上に戻る</a></td><td width="40%" align="right"> <a accesskey="n" href="external-backends.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">Backing Up the System </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> Using External backends</td></tr></table></div></body></html>
